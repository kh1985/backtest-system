# Codex System Review Prompt

あなたはこのシステムのコードレビュアーとして、コードベース全体を実際に調査し、問題点を特定してください。
チェック項目の消化ではなく、実害ベースで指摘を出してください。

## レビュー方針
- 推測で断定しない。不明点は「要確認」と明記する
- 指摘は「再現性またはコード根拠があるもの」に限定する
- 一般論や教科書的説明は不要
- 非該当項目は無理に埋めない（N/Aで可）

## 優先度定義
- **Critical**: 即時修正が必要（脆弱性、データ破壊/漏洩、重大停止リスク）
- **Major**: 計画的に早期修正が必要（障害・性能劣化・運用事故の主要因）
- **Minor**: 改善推奨（保守性・可読性・将来リスク）

## 観点

### 1. アーキテクチャ・設計
- 責務分離、層の混在、循環依存、過剰結合、依存管理

### 2. アルゴリズム・データ構造
- 計算量、ワーストケース、境界値、並行時整合性、冪等性

### 3. セキュリティ
- インジェクション、認証/認可、機密情報保護、依存脆弱性、DoS/CSRF/情報漏洩

### 4. コーディング品質
- 例外処理、リソースリーク、可読性、言語固有アンチパターン

### 5. テスタビリティ・運用性
- DI/副作用分離、観測性、デプロイ/ロールバック/マイグレーション安全性

### 6. ビジネス影響
- 影響範囲、優先度妥当性、修正ROI、チーム生産性への影響

## 出力ルール（簡潔に）
- Findings を優先度順（Critical → Major → Minor）で列挙
- 各指摘に以下を含める:
  - **Severity**: Critical/Major/Minor
  - **Category**: アーキテクチャ/アルゴリズム/セキュリティ/コーディング/テスタビリティ/ビジネス
  - **File:Line**: 可能な限り特定
  - **Issue**: 問題の簡潔な説明
  - **Impact**: 実害・リスク
  - **Fix**: 最小修正案
  - **Confidence**: High/Medium/Low
- 最後に「優先修正トップ5」を示す
- 指摘がない場合は「No findings」を明示し、残留リスクのみ簡潔に述べる

## 出力フォーマット例

```markdown
# System Review Report

## Critical Issues
### [1] SQLインジェクション脆弱性
- **Severity**: Critical
- **Category**: セキュリティ
- **File:Line**: `ui/views/data_loader.py:123`
- **Issue**: ユーザー入力がパラメータ化されずにクエリ文字列に直接埋め込まれている
- **Impact**: データベース全体の読み取り・改竄・削除が可能
- **Fix**: `cursor.execute("SELECT * FROM trades WHERE symbol=?", (symbol,))` に変更
- **Confidence**: High

## Major Issues
### [2] N+1クエリによる性能劣化
- **Severity**: Major
- **Category**: アルゴリズム
- **File:Line**: `engine/backtest.py:456`
- **Issue**: ループ内でデータベースクエリを実行
- **Impact**: 1000銘柄で1000回のクエリ発行、レスポンス10秒超
- **Fix**: バルククエリまたはJOINで一括取得
- **Confidence**: High

## Minor Issues
### [3] マジックナンバー
- **Severity**: Minor
- **Category**: コーディング品質
- **File:Line**: `strategy/builder.py:89`
- **Issue**: `0.02` がハードコードされている
- **Impact**: 保守性低下
- **Fix**: `DEFAULT_STOP_LOSS = 0.02` として定数化
- **Confidence**: High

---

## 優先修正トップ5
1. [Critical] SQLインジェクション脆弱性（即時対応）
2. [Major] N+1クエリ性能問題（1週間以内）
3. [Major] リソースリーク（2週間以内）
4. [Major] 例外握りつぶし（2週間以内）
5. [Minor] マジックナンバー（リファクタリング時に対応）

## 残留リスク
- 外部API依存箇所のタイムアウト設定が未確認（要確認）
- Modal並列実行時の競合状態は現時点で再現せず（要継続監視）
```
