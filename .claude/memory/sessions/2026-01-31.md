# 2026-01-31 セッションログ

## セッション 2026-01-31 (前セッションからの引き継ぎ含む)

### 実施内容
- Claude Code の Skills 6つを作成（syntax-check, check-results, commit-jp, inspect-json, run-app, add-template）
- PostToolUse Hook を設定（.py ファイル Edit/Write 後に自動 py_compile）
- CLAUDE.md にパフォーマンス最優先ルールを追加（forループ禁止、ベクトル演算必須）
- パフォーマンス違反箇所を全ファイルスキャンし、3箇所を修正
- optimizer_page.py: フィルタベースの読込ビュー、ファイル削除機能、plotly key修正（前セッションで実装、今回コミット）
- セッションメモリ機能（.claude/memory/）を設計・実装

### 変更ファイル
- `CLAUDE.md` — パフォーマンス最優先ルール追加 + セッションメモリ指示追加
- `data/timeframe.py` — マルチTFアライメントのforループを `reindex(method='ffill')` でベクトル化
- `indicators/volume.py` — VWAP計算のgroupbyループを `groupby().cumsum()` でベクトル化
- `optimizer/grid.py` — 未使用レガシーforループコード削除（_run_backtest, _run_with_trend_filter, _open_position, _force_close）計-144行
- `ui/views/optimizer_page.py` — フィルタUI（銘柄・TF・データソース）、ファイル削除、plotly_chart重複keyエラー修正
- `.claude/settings.json` — PostToolUse Hook（py_compile自動実行）
- `.claude/skills/` — 6スキル新規作成
- `.claude/skills/save-memory.md` — セッションメモリ保存スキル新規作成
- `.claude/memory/sessions/` — メモリディレクトリ新規作成

### 設計判断・決定事項
- **Skills vs Hooks**: Skills は手動（/command）、Hooks は自動。構文チェックのみ Hook 化
- **パフォーマンスルール**: 数値処理で Python forループ禁止。numpy/pandas ベクトル演算を必須とする
- **セッションメモリ方式**: 別ブランチ・別リポジトリではなく、同リポジトリ同ブランチの `.claude/memory/` に保存。理由: Claude Code が自動で読める、git pull で別PCに反映、セットアップが簡単
- **メモリ保存トリガー**: ユーザーが「メモリ保存して」と言ったら実行（VSCode拡張では /command 補完が効かないため）

### 未着手・保留
- 下落トレンド銘柄横断仮説の検証（議論のみ、実装指示なし）
- バッチ最適化のプラン（synchronous-spinning-llama.md）は実装済み
- hyperliquid-bot 側のメモリ機能セットアップ（必要になったら）

### メモ
- ユーザーは VSCode 拡張版の Claude Code を使用。`/` 補完が効かないので、スキルは日本語で指示してもらう
- ユーザーは複数PC（MacBook Air 等）で開発。git push/pull で同期する運用
- ユーザーはパフォーマンスに敏感。1mデータのforループで過去に痛い目にあっている
- コミットメッセージは日本語prefix（feat: / fix: 等）

## 重要な発見: レジームの逆説的活用 (2026-01-31)

### 15m MA Cross「Uptrend」ラベル = 下落途中の反発検出
- DOTUSDTの下落チャートで、Uptrendレジームのvolume_spike_short が +90.60%（354回）で最高PnL
- 15m MA Crossの「Uptrend」= マクロ下落中の一時的反発局面
- その反発をショートすることで「反発の天井を売る」戦略が成立

### RSI回復と15m MA Crossは同じ現象の別角度検出
- RSI 50-60（反発で売られすぎから回復）= 価格面の反発検出
- 15m SMA fast > SMA slow（ゴールデンクロス）= MA面の反発検出
- trend_pullback_short（RSI 50-60）を Uptrendレジームで走らせると、二重フィルターになり精度向上の可能性

### レジームの正しい理解
- レジームは「この相場環境でトレードしろ」ではない
- 「この局面を検知したらエントリーフィルターとして使え」という意味
- Uptrendラベル + ショート = 反発検知 → ショートの好機（逆説的だが合理的）
