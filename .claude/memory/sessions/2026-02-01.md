# 2026-02-01 セッションログ

## backtesting_principles.md 過学習防止機能の実装

### 実施内容
- backtesting_principles.md セクション7 ロードマップの Critical 3項目を全て実装
- バッチテスト 51件作成・全通過
- コミット `623a7b4` でプッシュ済み

### 実装した機能

#### 1. データ3分割 + OOS自動検証
- `optimizer/grid.py`: `data_range: Optional[Tuple[int, int]]` パラメータを全チェーンに追加
  - run() → _run_sequential() → _run_parallel() → _run_single() → _run_numba()
  - インジケーターは全データで計算、numpy配列のみスライスしてバックテスト実行
  - warm-up問題を回避（SMA/RSI/ADX等は全データで計算済み）
- `optimizer/validation.py`: 新規作成
  - `DataSplitConfig(train_pct=0.6, val_pct=0.2, top_n_for_val=10)`
  - `ValidatedResultSet`: train_results, val_best, test_results を保持
  - `run_validated_optimization()`: 3フェーズ実行（Train→Val→Test）
  - `_rebuild_configs_from_entries()`: config再構築（optimizer.runが破壊的にpopするため）

#### 2. 過学習警告フラグ
- `optimizer/scoring.py`: `detect_overfitting_warnings()` 追加
  - PF > 2.0 → 過学習の疑い
  - Sharpe > 3.0 → 非現実的
  - Trades < 30 → 統計的に不十分
  - OOS PnL 劣化 > 50% → Train→Test で大幅劣化
- `optimizer/results.py`: `warnings: List[str]` フィールド追加

#### 3. UI対応 + min_trades デフォルト変更
- `ui/views/optimizer_page.py`:
  - OOS設定セクション（チェックボックスON/OFF、Train%/Val%スライダー、Top-N入力）
  - `_execute_validated_optimization()`: OOS実行ロジック
  - `_render_oos_section()`: Train vs Val vs Test 比較テーブル、警告表示
  - min_trades デフォルト: 0 → 5

### テスト
- `tests/test_scoring.py`: 11テスト（スコア正規化、警告条件4種）
- `tests/test_results.py`: 13テスト（warnings、フィルタ、DataFrame変換、JSON復元）
- `tests/test_validation.py`: 11テスト（DataSplitConfig、3フェーズ呼び出し、data_range伝播）
- `tests/test_grid_data_range.py`: 6テスト（_BacktestTask、numpyスライス、run()伝播）

### 技術的判断
- **インジケーターwarm-up回避**: 全データで計算→numpy配列スライスの方式。情報漏洩なし（SMA等は全てバックワードルッキング）
- **config再構築**: optimizer.run()が `_template_name`, `_params` を破壊的にpopするため、deep copy + 再付与が必要
- **進捗管理**: 3フェーズの進捗を grand_total で統合管理、フェーズ別ラベル [Train]/[Val]/[Test] 付き

---

## backtesting_principles.md ロードマップ進捗

### 完了（Critical）
| # | 項目 | 状態 |
|---|------|------|
| 1 | データ3分割 (Train/Val/Test) | ✅ |
| 2 | OOS自動検証 | ✅ |
| 3 | 過学習警告フラグ | ✅ |

### 次に取り組むべき（Important）
| # | 項目 | 状態 | 備考 |
|---|------|------|------|
| 4 | **Walk-Forward Analysis** | ❌ | ローリングOOS期間で一貫性検証。次の最優先候補 |
| 5 | BT→FW 劣化率の表示 | ⚠️ 部分的 | Train→Test劣化率は表示済み。WF形式はまだ |
| 6 | 最低トレード数フィルタ | ✅ | デフォルト5に変更済み |

### 将来的（Nice to have）
| # | 項目 | 状態 |
|---|------|------|
| 7 | モンテカルロシミュレーション | ❌ |
| 8 | CPCV実装 | ❌ |
| 9 | 複数銘柄OOS横断分析 | ❌ |

### ドキュメント内のその他未実装項目
- Sortino Ratio > 3.0 警告（Sortino自体がmetricsに未実装）
- Test Sharpe < 1.0 自動棄却ロジック
- 特徴量相関±0.6超の除去（テンプレート設計レベル）
- ボラティリティ閾値による自動停止メカニズム

### ユーザー判断待ち
- Walk-Forward Analysis の実装に進むか、まず現状のOOS機能を実データで動かして検証するか

---

## Aランク実装完了: Walk-Forward Analysis + Multi-Symbol Cross-Validation

### 優先度付けの経緯
ロードマップの残項目に A/B/C/D の優先度を付与:
- **A**: WFA + Multi-Symbol Cross-Validation（過学習防止パイプラインの完成形）
- **B**: BT→FW劣化率改善、UIエクスポート拡張
- **C**: モンテカルロ、CPCV
- **D**: Sortino、特徴量相関、ボラ停止

ユーザー判断: 「Aまで実装したら現実的に使用できるツール」→ 実装開始

### 計画（melodic-munching-breeze.md）
- Anchored WFA: IS開始を常に0に固定、ISが段階的に拡大
- CV: バッチ結果をテンプレート単位でグルーピング、銘柄横断で判定

### 実装内容

#### A1: Walk-Forward Analysis
- **`optimizer/walk_forward.py`**: 新規作成
  - `WFAConfig`: n_folds=5, min_is_pct=0.4, use_validation=True, val_pct_within_is=0.2, top_n_for_val=10, min_trades_for_val=30
  - `WFAConfig.compute_fold_ranges(n)`: Anchored方式のfold区間計算
  - `WFAFoldResult`: 1フォールドの結果（IS範囲, OOS範囲, 選択戦略, OOS結果）
  - `WFAResultSet`: 全体結果（folds, wfe, consistency_ratio, stitched_oos_pnl, strategy_stability, final_train_results）
  - `run_walk_forward_analysis()`: メインエントリー。fold毎にIS→OOS実行、集約メトリクス計算
  - `_run_is_phase()` → `_run_is_direct()` or `_run_is_with_validation()`
  - `_compute_aggregate_metrics()`: WFE, CR, stitched PnL, strategy stability
- **`tests/test_walk_forward.py`**: 19テスト全通過

**主要メトリクス・判定:**
| 指標 | 定義 | 合格基準 |
|------|------|---------|
| WFE | mean(OOS PnL) / mean(IS PnL) | > 0.3 |
| Consistency Ratio | OOS正のフォールド割合 | >= 60% |
| Stitched OOS PnL | 全OOS PnLの合計 | > 0 |
| Strategy Stability | 同一戦略が選ばれた割合 | 高いほど良い |
| 判定 | CR>=0.6 AND WFE>0.3 → PASS, CR>=0.4 → CAUTION, else FAIL |

#### A2: Multi-Symbol Cross-Validation
- **`optimizer/cross_validation.py`**: 新規作成
  - `CrossValidationVerdict`: ALL_PASS / MAJORITY / MINORITY / FAIL
  - `StrategyProfile`: テンプレート別の銘柄横断結果（passed/failed銘柄, avg_pnl, verdict）
  - `RegimeCrossResult`: 1レジームの全プロファイル + dominant_template
  - `CrossValidationResult`: 全体結果
  - `run_cross_validation()`: バッチ結果 → テンプレートグルーピング → 判定
  - 判定: pass_rate=1.0→ALL_PASS, >=0.5→MAJORITY, >0→MINORITY, else FAIL
- **`tests/test_cross_validation.py`**: 9テスト全通過

#### UI変更（`ui/views/optimizer_page.py`）
- **検証モード3択**: `st.radio` で OFF / OOS 3分割 / Walk-Forward Analysis
- **WFA設定パネル**: フォールド数(3-10), 最小IS割合(30-60%), IS内Val分割チェック, Val設定
- **`_execute_wfa_optimization()`**: 新関数。トレンドラベル → config生成 → `run_walk_forward_analysis` 呼出
- **`_run_optimization()`**: `oos_enabled` → `validation_mode` に変更。off / oos_3split / wfa の3分岐
- **`_render_wfa_section()`**: 新関数。PASS/CAUTION/FAILバナー、集約メトリクス4指標、フォールド別詳細テーブル
- **`_render_results_view()`**: WFA結果 → OOS結果 → レジームベストの順で表示
- **比較ビュー**: 3銘柄以上で「🔬 クロスバリデーション」タブ自動追加
- **`_render_cross_validation_tab()`**: 新関数。テンプレート別判定テーブル + バナー
- **`_generate_results_markdown()`**: WFAセクション追加（判定、メトリクス、フォールド別テーブル）

### テスト結果
- 全82テスト通過（WFA 19 + CV 9 + 既存 54）
- 構文チェック全パス

### 設計判断
- **Anchored WFA**: Rolling ではなく Anchored を採用。ISが段階的に拡大するため、学習データ量の影響も評価できる
- **final_train_results**: 最終フォールドのIS結果を結果ビュー用に保持。WFA実行後もランキングテーブル等が表示可能
- **CVはバッチ結果から自動実行**: 個別実行ではなく、比較ビューで3銘柄以上揃った時に自動で`run_cross_validation`を呼ぶ
- **バッチ実行は既存のまま**: `_execute_single_optimization` を直接呼ぶパス。WFA/OOS対応はバッチには不要（個別実行で検証し、バッチはCV用）

### コミット済み
- コミット・プッシュ完了。ユーザーの指示を待つ

### ロードマップ現在地
| 優先度 | 項目 | 状態 |
|--------|------|------|
| Critical | データ3分割 + OOS検証 | ✅ |
| Critical | 過学習警告フラグ | ✅ |
| Critical | 最低トレード数フィルタ | ✅ |
| **A** | **Walk-Forward Analysis** | **✅ 完了** |
| **A** | **Multi-Symbol Cross-Validation** | **✅ 完了** |
| B | BT→FW劣化率改善 | 部分的（OOS劣化率は表示済み） |
| C | モンテカルロ | ❌ |
| C | CPCV | ❌ |
| D | Sortino等 | ❌ |

### コミット
- `ee6f6ae` でプッシュ済み

---

## バグ修正・UI改善（セッション後半）

### CV テンプレート不一致バグ修正
- **問題**: CVタブと詳細比較タブで同一銘柄・レジームに異なるテンプレートが表示される
- **原因**: `cross_validation.py` が `.best`（composite_score基準）を使用、詳細タブは `.best_by_pnl`（PnL基準）
- **修正**: `cross_validation.py:107` を `.best` → `.best_by_pnl` に変更

### CV が OOS 結果を使用するよう改善
- **問題**: CVタブが常にTrain結果を使用。OOS検証してもCVに反映されない
- **修正**: `_build_cv_results()` ヘルパー追加。`batch_validated` → test_results、`batch_wfa` → 最終fold OOS結果、フォールバックでTrain結果
- CVタブにデータソース表示（OOS Test / WFA OOS / Train + 警告）

### 年度フィルタ + data_period 伝播
- **問題**: ファイル読み込みページの年度フィルタが実行日（全て2026）のみ表示
- **修正**:
  1. オリジナルデータ選択時に `OHLCVData.start_time/end_time` から期間取得
  2. `_save_results()`: `data_period` を全データソースでJSON保存（trimmed限定→全て）
  3. JSON内の `data_period` を `results` の前に配置（高速読み取り対応）
  4. `_read_data_period_from_json()`: 先頭2KB + 末尾500Bから年を高速抽出
  5. 年度フィルタを `data_year`（データ期間開始年）基準に変更
- **マイグレーション**: `scripts/backfill_data_period.py` で既存JSONに一括付与可能
- 旧結果は `results_backup/` にバックアップ後削除済み

### Markdown エクスポート改善
- タブ別ボタン配置（メタ分析 / 詳細比較 / クロスバリデーション）
- CVタブのMarkdownも OOS データソースを反映

---

## 30銘柄バッチ OOS検証結果の分析

### 実行条件
- 30銘柄、exec_tf=15m、htf=1h、OOS 3分割（Train 60% / Val 20% / Test 20%）
- 入力データ: 20250201-20260130（約1年分）

### CVで使えそうな戦略

| レジーム | テンプレート | OOS通過率 | 平均OOS PnL | 評価 |
|---------|------------|----------|-------------|------|
| **Range** | **macd_signal_short** | **85% (11/13)** | **+5.49%** | **最有力** |
| Range | trend_pullback_short | 57% (4/7) | +5.62% | 次点 |
| Downtrend | volume_spike_short | 67% (4/6) | +3.70% | 条件付き |
| Downtrend | ma_crossover_short | 59% (10/17) | +1.44% | 微妙 |
| **Uptrend** | **全テンプレート** | **ほぼ全滅** | **マイナス** | **過学習** |

### 重要な発見
- **Range + macd_signal_short が最も信頼性高い**: 13銘柄中11銘柄でOOS通過、平均+5.49%
- **Uptrend戦略はTrainで全銘柄プラスだがOOSではほぼ全滅**: 典型的な過学習パターン
  - ma_crossover（最多採用14銘柄）→ OOS通過率21%、平均PnL -4.53%
- OOS検証パイプラインが過学習フィルタとして正しく機能していることを確認

### 次のステップ候補
- Range + macd_signal_short を個別銘柄でWFA検証（時間的一貫性の確認）
- Uptrend向けテンプレートの再設計（現行テンプレートでは過学習が顕著）
- 実運用前にスプレッド・手数料込みの実効リターンを評価

---

## フル自動化パイプライン実装（セッション後半 Part 2）

### 背景
壁打ちで3つの盲点を発見:
1. **TP/SL が全テンプレートで固定 (2%/1%)** → ATRベースで動的化
2. **TF が 15m/1h のみ未探索** → 6パターン全探索
3. **SLハント問題** → SLなし戦略も検証すべき

### 実装内容（全4フェーズ）

#### Phase 1: ATRベースexit対応（エンジン改修）
- **`engine/numba_loop.py`**:
  - `_compute_tp_sl()`: ATR/固定%/SLなしを統一処理するヘルパー
  - `_backtest_loop()`: ATR4パラメータ追加（atr, use_atr_exit, atr_tp_mult, atr_sl_mult）
  - `_backtest_loop_regime_switching()`: レジーム別ATRパラメータ追加
  - `compute_atr_numpy()`: numpy純粋ATR計算
  - **sl_pct=0 バグ修正**: 旧コードで `sl_price = entry_price` になり即SL発動 → -1.0/1e18 で無効化
- **`optimizer/grid.py`**: `_run_numba()` でATR配列計算+Numbaへ伝播、data_rangeスライス対応
- **`strategy/base.py`**: `ExitRule` に `use_atr_exit`, `atr_tp_mult`, `atr_sl_mult`, `atr_period` 追加
- **`optimizer/regime_switching.py`**: `_extract_exit_params()` ATR対応、ATR配列計算+Numba伝播

#### Phase 2: Exit Profiles + テンプレート改修
- **`optimizer/exit_profiles.py`** (新規):
  - 10種の exit profile（固定%3種 + ATR3種 + SLなし2種 + ハイブリッド2種）
  - `get_profiles(mode)`: "all"/"fixed"/"atr"/"no_sl"/"hybrid"
- **`optimizer/templates.py`**: `generate_configs(exit_profiles=...)` 追加
  - エントリー条件 x exit条件 の直積生成
  - `_exit_profile` メタデータ付加
  - 後方互換（exit_profiles=None で従来動作）

#### Phase 3+4: バッチ自動最適化パイプライン v2
- **`scripts/batch_optimize.py`** (大規模リライト):
  - Multi-TF: 6パターン (`1m/15m`, `1m/1h`, `15m/1h`, `15m/4h`, `1h/4h`, `1h/1d`)
  - OOS 3分割検証統合 (`--oos` / `--no-oos`)
  - Exit profiles統合 (`--exit-profiles all/fixed/atr/no_sl/hybrid/none`)
  - 自動ランキング: `auto_rank()` → スコア = OOS通過率*0.4 + PnL*0.3 + 期間一貫性*0.2 + 銘柄カバー率*0.1
  - Markdownレポート生成: 推奨戦略Top20、Exit比較、TF比較、レジーム別詳細、過学習警告
  - CLIオプション: `--tf-combos`, `--symbols`, `--periods`, `--workers`, `--force`

### テスト
- `tests/test_atr_exit.py`: 17テスト（_compute_tp_sl, compute_atr_numpy, _backtest_loop ATRモード）
- `tests/test_exit_profiles.py`: 18テスト（プロファイル定義、テンプレート直積、後方互換）
- 既存54テスト + WFA 19 + CV 9 + 新規35 = **全117テスト通過**
- 全変更ファイル構文チェックパス

### 使い方
```bash
# フル実行
python scripts/batch_optimize.py

# 小規模テスト
python scripts/batch_optimize.py --symbols BTCUSDT,ETHUSDT --periods 20250201-20260130 --tf-combos 15m:1h

# 固定%のみ（高速）
python scripts/batch_optimize.py --exit-profiles fixed --tf-combos 15m:1h

# OOSなし（最速）
python scripts/batch_optimize.py --no-oos --exit-profiles none --tf-combos 15m:1h
```

### コミット済み
- コミット・プッシュ完了

---

## 2026-02-03 BB帯動的exit実装完了

### 実装内容
- **BB帯動的exit**: Numbaループでロング→上限バンド、ショート→下限バンドでTP価格を毎バー更新
- **BB/Stochasticカラム名修正**: `bb_lower` → `bb_lower_{period}` 形式に統一
- **BB exit profiles追加**: `bb_exit_sl1`, `bb_exit_sl0.5`, `bb_exit_atr_sl`

### 変更ファイル
- `engine/numba_loop.py`: bb_upper, bb_lower, use_bb_exit パラメータ追加
- `indicators/volatility.py`: BBカラム名にperiod付加
- `indicators/momentum.py`: Stochasticカラム名にperiod付加
- `optimizer/grid.py`: BB配列計算してNumbaに渡す処理
- `optimizer/exit_profiles.py`: BB_PROFILES追加
- `strategy/base.py`: ExitRuleにuse_bb_exit, bb_period追加
- `tests/test_atr_exit.py`: BBパラメータ追加

### コミット
- `d759a3d` feat: BB帯動的exit追加 + ATR exit対応 + SharedMemory最適化

### 次のステップ
- BB exitを含むバッチ最適化の実行
- 高回転戦略（1日1トレード以上）の探索
  - 15m MA crossでトレンド判定 + 1m BBで-2σエントリー、+2σでexit
