# 2026-02-05 セッションログ (続き)

## 実施内容

### GA + OOS検証の完全実装

1. **OOSキャッシュバグ修正**
   - 問題: Train期間とTest期間で同じキャッシュが使われていた
   - 原因: `IndicatorCache.get_key()`がインジケーター設定だけでキーを生成
   - 修正: キャッシュキーにDataFrameのサイズ（`df_size`）を含めるよう変更
   - ファイル: `optimizer/grid.py`

2. **ブラックリスト機能実装**
   - 新規ファイル: `optimizer/blacklist.py`
   - OOS検証でFAILした組み合わせ（銘柄×レジーム×テンプレート）を自動記録
   - 次回GA実行時にブラックリスト該当をスキップ
   - UI: 「🚫 ブラックリスト」タブで確認・削除可能
   - テンプレート選択UIに `(BL: N)` で件数表示

3. **採用スコア導入**
   - 計算式: `Test_PnL × 0.4 + 安定度(Test/Train比率) × 0.3 + トレード数正規化 × 0.3`
   - 採用条件: PASS かつ 採用スコア >= 0.5 → ⭐
   - GA結果テーブルに「安定度」「採用スコア」「採用」列を追加

4. **GA結果フィルタ機能**
   - 判定フィルタ: すべて / PASSのみ / FAILのみ
   - 最小トレード数フィルタ（統計的信頼性確保）

5. **2段階ワークフロー実装（GA → グリッドサーチ）**
   - GA結果画面に「🚀 グリッドサーチ開始」ボタン追加
   - 採用候補（⭐）の銘柄×テンプレートを自動選択
   - バッチ実行画面で自動設定反映
   - 「❌ 設定をクリア」ボタンで解除可能

### 進捗表示修正
- GA実行時の進捗ラベルを「🧬 GA」に変更
- GA完了時に進捗バーを「完了」状態に更新

---

## 採用判断の考え方

### 信頼性の指標
1. **Test PnL**: 未知データでのパフォーマンス（最重要）
2. **安定度 (Test/Train比率)**: 1.0以上なら過学習なし
3. **トレード数**: 50回以上で統計的に意味がある
4. **汎用性**: 複数銘柄でPASSしているテンプレートは堅牢

### 注意すべきパターン
- Train期間高い → Test期間低い = 過学習
- トレード数1-5回でPASS = 偶然の可能性高い
- Train マイナス → Test プラス = 怪しい（たまたまTest期間が良かった）

---

## 発見: 有望なテンプレート

### vp_pullback_long（多くの銘柄でPASS）
- Volume Profile のLVN（出来高の谷）に価格が初タッチでロング
- 出来高分布は価格パターンに依存しないため過学習しにくい
- パラメータ: n_bins（30-70）、touch_tolerance（0.3-0.7）

### 成績上位
```
TRXUSDT vwap_upper1_long: +80% → +32% (267回) ★★★
ATOMUSDT stochastic_reversal_short: +51% → +18% (638回) ★★★
INJUSDT volume_spike_short: +45% → +13% (258回) ★★★
```

---

## ワークフロー確定

```
Step 1: GA（高速スクリーニング）
   → 全テンプレート × 全銘柄 × 全レジーム
   → 採用候補（⭐）を絞り込み

Step 2: グリッドサーチ（詳細最適化）
   → 採用候補のテンプレートだけをパラメータ網羅
   → 最終採用
```

---

## 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `optimizer/grid.py` | キャッシュキーにdf_size追加 |
| `optimizer/blacklist.py` | 新規作成（ブラックリスト管理） |
| `ui/views/batch_optimizer.py` | GA+OOS、採用スコア、2段階ワークフロー |
