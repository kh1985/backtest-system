# 2026-02-07 セッションログ

## セッション1: 固定OOS → WFA移行（午前）

### 1. 3期間独立OOS検証（Modal）

**Run ID**: `20260207_101117`
**条件**: volume_spike_short固定 × 10銘柄 × 3期間（2023/2024/2025） × atr_compact × Dual-TF EMA

#### 結果: 2025年にPASSが偏り
| 期間 | PASS数 | 主な銘柄 |
|------|--------|---------|
| 2023 | 1/10 | AVAX +3.9%(86件) |
| 2024 | 1/10 | TRX +0.5%(31件) |
| **2025** | **8/10** | ADA+16.4%, DOGE+14.5%, ETH+8.3%... |

### 2. レジーム分布分析 → OOS偏りの発見

2025年Test区間のdowntrendが45%（通常30%台）→ ショート戦略に追い風だった。

### 3. WFA初回実行: volume_spike_short/downtrend → 壊滅（1/10）

**Run ID**: `20260207_112810_wfa`
固定OOS「6/10 PASS」がWFAで「1/10 PASS」に逆転。

---

## セッション2: 包括的WFA + 複合条件化（午後）

### 4. 4テンプレート × 3レジーム WFA

**Run ID**: `20260207_115401_wfa`
**条件**: volume_spike_short, ma_crossover_short, rsi_reversal_short, bb_bounce_short × 3レジーム × 10銘柄

#### 結果（CR >= 60% PASS）
| レジーム | PASS | PnL+のPASS | 主な銘柄 |
|---------|---:|---:|---|
| Range | 7/10 | 3 | XRP(CR100%,+14.5%), AVAX(+10.1%), ETH(+4.0%) |
| Uptrend | 5/10 | 4 | DOT(+33.0%), ADA(+18.2%), DOGE(+5.8%) |
| Downtrend | 3/10 | 2 | SOL(+8.1%), XRP(+2.1%) |

**年率推定（Range 3銘柄均等配分）: 約5.3%**（OOS期間1.8年換算）

### 5. 全21テンプレート × 3レジーム WFA

**Run ID**: `20260207_124018_wfa`
**条件**: 全21テンプレート × 3レジーム × 10銘柄（1449 configs）

#### 結果
| レジーム | PASS | 4テンプレ時 | 変化 |
|---------|---:|---:|---|
| Range | 3/10 | 7/10 | **大幅減**（過学習増加） |
| Uptrend | 5/10 | 5/10 | 同等 |
| Downtrend | 3/10 | 3/10 | 同等 |

### 6. 比較分析で判明した重要事実

**テンプレート数増加の影響（30件中）:**
- 14件: 両Run完全一致（追加テンプレが影響せず）
- 10件: 追加テンプレで**悪化**
- 6件: 追加テンプレで**改善**

→ **追加テンプレが害になる確率62.5%**。典型的な複数比較問題。

**過学習の犯人:**
- volume_spike(Long): ISでpf=9999 → OOS全崩壊
- macd_signal_short: 大量シグナル → OOS-6.23%
- stochastic_reversal: ISで高Sharpe → OOS不安定

**唯一有益だった新テンプレ**: ma_crossover(Long) → AVAX/range +25.8%

**結論: 探索空間は小さく保つのが正解。フィルタより制約。**

### 7. 複合条件テンプレート4種追加

`optimizer/templates.py` に追加:

| テンプレート | 条件 | Side | Configs |
|------------|------|------|------:|
| rsi_volume_short | RSI買われすぎ + RVOL + 陰線 | Short | 54 |
| rsi_volume_long | RSI売られすぎ + RVOL + 陽線 | Long | 54 |
| bb_volume_short | BB上限 + RVOL + 陰線 | Short | 27 |
| bb_volume_long | BB下限 + RVOL + 陽線 | Long | 27 |

→ 既存5種(216) + 新規4種(162) = 計378 configs

---

## 重要な学び（セッション2）

### 探索空間サイズと過学習の関係
- 4テンプレ(216 configs): Range 7/10 PASS
- 21テンプレ(1449 configs): Range 3/10 PASS
- **config数が多いほどISで「たまたまの勝者」が出やすい**
- **テンプレート数を増やすな。既存テンプレの精度を上げろ**

### フィルタ vs 制約
- IS sanity filter（pf>10除外等）は偽陰性リスクあり（本物を弾く可能性）
- 真に強い戦略は探索空間サイズに関係なく勝つ（14/30件で完全一致）
- **結論: フィルタより探索空間の制約が安全で確実**

### 両Run共通でロバストな組み合わせ
| 銘柄 | レジーム | PnL | CR | テンプレート |
|------|---------|----:|---:|---|
| DOT | uptrend | +33.0% | 80% | rsi_reversal |
| ADA | uptrend | +18.2% | 60% | bb_bounce |
| XRP | range | +14.5% | 100% | bb_bounce_short / rsi_reversal_short |
| SOL | downtrend | +8.1% | 80% | rsi_reversal / rsi_reversal_short |

---

## 次回のアクション

1. **複合条件テンプレートのWFA検証**（Modal）
   - 新規4テンプレ単独 → 効果確認
   - 既存5種+新規4種の9種合計 → 混合効果確認
2. 結果次第で複合条件の調整 or 追加
3. ロバスト組み合わせのYAML戦略エクスポート検討

## 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `optimizer/templates.py` | 複合条件テンプレート4種追加（rsi_volume, bb_volume） |
| `scripts/modal_wfa.py` | `--templates all` サポート追加 |
| `scripts/modal_download.py` | `wfa/` サブディレクトリ対応追加 |
| `scripts/modal_regime_check.py` | 新規（前セッション） |
