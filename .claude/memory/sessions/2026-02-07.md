# 2026-02-07 セッションログ

## 実施内容

### 1. 3期間独立OOS検証（Modal）

**Run ID**: `20260207_101117`
**条件**: volume_spike_short固定 × 10銘柄 × 3期間（2023/2024/2025） × atr_compact × Dual-TF EMA
**実行時間**: 16秒（30ジョブ）

#### 結果: downtrend PASS数
| 期間 | PASS数 | 主な銘柄 |
|------|--------|---------|
| 2023 | 1/10 | AVAX +3.9%(86件) |
| 2024 | 1/10 | TRX +0.5%(31件) |
| **2025** | **8/10** | ADA+16.4%, DOGE+14.5%, ETH+8.3%... |

→ **2025年にPASSが偏っている** ことが判明

---

### 2. レジーム分布分析（Modal）

`scripts/modal_regime_check.py` を新規作成。各銘柄×各期間のDual-TF EMAレジーム分布を計算。

#### 期間別平均
| 期間 | Uptrend | Downtrend | Range |
|------|---------|-----------|-------|
| 2023 | 34.1% | 35.8% | 30.1% |
| 2024 | **38.2%** | **31.5%** | 30.4% |
| 2025 | 29.8% | **38.7%** | 31.5% |

→ 年度全体で見ると、downtrend比率の差は最大7%程度

---

### 3. OOS分割のTest区間レジーム分布（核心の発見）

OOS分割のTest区間（後半20%）のdowntrend割合を調査。

| 期間 | Train Down% | **Test Down%** |
|------|:-:|:-:|
| 2023 | 41.5% | **29.8%** |
| 2024 | 34.7% | **32.7%** |
| **2025** | 34.9% | **45.1%** |

**2025年のTest区間はdowntrendが45%**。アルト勢は特にひどい:
- DOGE: **59.5%**、DOT: **59.1%**、ADA: **53.1%**、XRP: **53.6%**

**結論**: 2025年のOOS PASSが多かったのは「戦略が優秀」ではなく「Test区間がdowntrendだらけ → ショート戦略に追い風」だった。**固定OOS分割の構造的弱点**。

---

### 4. WFA実行（Modal）— 決定的結果

**Run ID**: `20260207_112810_wfa`
`scripts/modal_wfa.py` を新規作成。既存の `optimizer/walk_forward.py` をModal上で実行。

**条件**: 10銘柄 × 3年分結合(~35,000bars) × Anchored WFA 5フォールド × volume_spike_short × downtrend

#### 結果: **PASS 1/10（壊滅）**

| 銘柄 | CR (一貫性) | OOS合計PnL | 判定 |
|------|:-:|:-:|:-:|
| BTC | 40% (2/5) | -8.1% | FAIL |
| ETH | 20% (1/5) | -20.2% | FAIL |
| BNB | 0% (0/5) | -15.3% | FAIL |
| SOL | 20% (1/5) | +2.3% | FAIL |
| **XRP** | **60% (3/5)** | -19.5% | **PASS** |
| ADA | 0% (0/5) | -39.8% | FAIL |
| AVAX | 20% (1/5) | -23.2% | FAIL |
| DOGE | 20% (1/5) | -24.9% | FAIL |
| DOT | 20% (1/5) | -26.8% | FAIL |
| TRX | 0% (0/5) | -5.4% | FAIL |

**volume_spike_short / downtrendは時間的に頑健ではなかった。**
固定OOSで「6/10銘柄PASS、エッジ確定！」と判定した結果は、OOS分割の偏りに騙されていた。

---

## 重要な学び

### 固定OOSの限界
- 固定時系列分割（Train60/Val20/Test20）では、Test区間の相場環境に結果が左右される
- 特にレジーム別戦略では、Test区間のレジーム割合が直接パフォーマンスに影響
- **固定OOSは候補のスクリーニングには使えるが、最終判定には不十分**

### WFAの必要性
- ローリングウィンドウで複数回テストすることでTest区間の偏りが消える
- `optimizer/walk_forward.py` は以前から実装済みだった（UIからは使えた）がModal版がなかった
- **今後はWFAを標準検証手段とすべき**

### 過学習の本質
- 今回の問題は「パラメータの過学習」ではなく「評価方法の欠陥」
- 正しい評価方法（WFA）を使うと、Step 2で見つかった「エッジ」は消えた
- これまでのStep 1-3の作業は「候補絞り込み」としては有効だったが、最終判定が甘かった

---

## 新規作成ファイル

| ファイル | 用途 |
|---------|------|
| `scripts/modal_regime_check.py` | 銘柄×期間のレジーム分布計算（Train/Val/Test区間別） |
| `scripts/modal_wfa.py` | Modal上でWFA実行（3年分結合 × Anchored 5フォールド） |

---

## 次回の方針（要議論）

### 検討すべきこと
1. **他のテンプレートもWFAで検証**: volume_spike_short以外（ma_crossover_short, rsi_reversal等）はどうか？
2. **range系テンプレートのWFA**: 固定OOSでは range > downtrend の傾向があった。rangeのWFAは？
3. **テンプレート構造の限界**: 現行21種の単純テンプレートでは3年間の一貫したエッジが見つからない可能性
4. **戦略自体の見直し**: レジーム固定のシンプルテンプレートではなく、複合条件やアダプティブな戦略が必要か

### 未コミット変更
- `scripts/modal_optimize.py`: min_oos_trades パラメータ追加
- `scripts/modal_regime_check.py`: 新規
- `scripts/modal_wfa.py`: 新規
- `.claude/memory/roadmap.md`: ロードマップ

### 前回からの未着手
- minaraai着想の新テンプレート（RSI7, EMA Crossover等）
- テンプレートの複合条件化（AND条件追加）
