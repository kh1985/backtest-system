# 2026-02-06 セッションログ

## minaraai自動取引ログの分析

ユーザーがminaraai（自動取引AI）の判断ログを持ち込み、Prismに活かせないか検討。

### minaraaiのロジック概要

- **マルチTF統合判断**: 4H（トレンド方向）→ 15m（エントリータイミング）→ 3m（精度）
- **使用インジケーター**: EMA20/50, MACD, RSI7/RSI14, Volume, OI, Funding Rate
- **判断フレームワーク**:
  1. Sharpe Ratioで実行モード切替（低い→保守的、高い→攻める）
  2. 既存ポジション確認 → 新規シグナル検出
  3. 銘柄別に信頼度スコア（0-100）を算出、閾値≥70で実行
  4. 条件未達なら「待つ」判断が可能
- **対象**: BTC, ETH, SOL（3銘柄同時監視）
- **分析時の状況**: 全3銘柄が4H下落トレンド内で15m反発中 → 全銘柄「待ち」判断

### Prism vs minaraai 比較結論

| 領域 | Prismが強い | minaraaiが強い |
|------|------------|---------------|
| 戦略探索 | 21テンプレート × グリッド/GA × exit profiles | 固定ロジック1つ |
| 過学習検出 | OOS/WFA/CV | なし |
| 統計的検証 | 30銘柄横断バッチ | 3銘柄個別 |
| リアルタイム判断 | なし（バックテストのみ） | 即時売買判断 |
| 複合条件の質 | 瞬間スナップショット | 状態の推移を読む |
| 「待つ」判断 | なし（条件合えば常にエントリー） | 信頼度閾値で見送り可 |
| OI/Funding | 未対応 | 判断材料として使用 |

**本質**: Prism=研究者（統計的発見）、minaraai=トレーダー（リアルタイム文脈判断）。補完関係。

---

## Modal本番実行 & 結果分析

### 実行概要
- **Run ID**: 20260206_105242
- **5銘柄 × OOS × 全exit profiles**: 528,885コンボ（各105,777）
- **実行時間**: 738秒（12.3分）
- **ローカル推定**: 3時間 → Modal 5並列で約5倍高速

### 5銘柄分析結果

| 銘柄 | Uptrend | Range | Downtrend | ベスト |
|------|---------|-------|-----------|--------|
| BTCUSDT | FAIL | FAIL | FAIL | なし |
| ETHUSDT | FAIL | PASS +0.7% | FAIL | range/volume_spike_short |
| BNBUSDT | PASS +0.29% | PASS +1.5% | PASS +4.04% | **downtrend/ma_crossover** |
| SOLUSDT | FAIL | FAIL | PASS +0.12% | ほぼゼロ |
| XRPUSDT | FAIL | PASS +3.30% | FAIL | range/stochastic_reversal_short |

### 主要な発見
- **レジーム傾向**: range > downtrend > uptrend（2/1結果と一致）
- **bb_exit_atr_sl20** がOOS通過した2戦略で共通 → 信頼できるexit profile候補
- **BTC/ETH**: エッジ発見が最も難しい（流動性高い＝非効率性少ない）
- **BNB**: 唯一3レジーム全通過（中規模アルトの特性か）
- **推奨戦略**: ランキングで0件（銘柄数1のため推奨基準未達）

---

## Modal直接データ取得スクリプト実装

### `scripts/modal_fetch_data.py`（新規作成）
- Binance data.binance.vision → Modal Volume に直接ダウンロード
- ローカルCSVダウンロードが不要に
- 銘柄ごとに`.spawn()`で並列実行
- `--list`フラグでVolume内の既存データ確認可能

### 完全クラウドワークフロー
```
modal run scripts/modal_fetch_data.py     # データ取得（Binance → Volume）
modal run scripts/modal_optimize.py       # 最適化実行
modal run scripts/modal_download.py       # 結果DL
```

---

## Modalスクリプト一覧

| スクリプト | 用途 |
|-----------|------|
| `scripts/modal_fetch_data.py` | Binance → Modal Volumeに直接データDL |
| `scripts/modal_upload.py` | ローカルCSV → Modal Volumeアップロード |
| `scripts/modal_optimize.py` | Modal上でバッチ最適化実行 |
| `scripts/modal_download.py` | Modal Volume → ローカルに結果DL |

### Windows注意点
- Pythonパス: `C:\Users\k-hachiya\AppData\Local\Programs\Python\Python312\python.exe`
- cp932エンコーディング問題: `PYTHONUTF8=1 PYTHONIOENCODING=utf-8` を付ける

---

---

## Dual-TF EMA レジーム検出 実装

### 背景
- minaraaiの3層TF分析（4H→15m→3m）に触発
- 従来の1h SMA20/50 のみのレジーム判定はノイジーで、OOS通過率が低い
- 4hと1hの両方で方向が一致した場合のみトレンドと判定する方式を導入

### 実装内容（コミット: `2c4faff`）
- **`analysis/trend.py`**: `detect_dual_tf_ema()` メソッド追加
  - 4h EMA20/50 方向 + 1h EMA20/50 方向
  - 両方 up → uptrend、両方 down → downtrend、不一致 → range
  - `pd.merge_asof` で 4h→1h ラベル伝播（ルックアヘッド防止）
- **`scripts/modal_optimize.py`**: `--super-htf` オプション追加（デフォルト: `4h`）
  - 4hデータなし時は従来の MA Cross にフォールバック

### EMA vs SMA の選択理由
- EMAの方がトレンド反応が速い
- SMAのrange_threshold_pct=0.1%は狭すぎた → Dual-TFでは不一致=rangeで自然に判定

### Parabolic SAR を採用しなかった理由
- SARはup/downの2択のみ（rangeが定義できない）
- レンジ相場で高速フリップしてチャタリング発生
- レジーム分類にはEMAが適切（SARはエントリー/エグジットタイミング向き）

---

## Dual-TF EMA テスト結果（Run ID: 20260206_140419）

### 条件
- **期間**: 2年分（2024-02 〜 2026-01）
- **銘柄**: BTC, SOL, XRP（BTCと値動きが異なるアルト2銘柄を選定）
- **TF**: 15m実行 / 1h+4h レジーム / OOS ON / 全exit profiles
- **実行時間**: 25.1分（3銘柄 × 105,777コンボ）

### OOS結果

| 銘柄 | Uptrend | Downtrend | Range | 合計PnL |
|------|---------|-----------|-------|---------|
| BTCUSDT | PASS +2.3% | FAIL -0.4% | FAIL -3.5% | -1.6% |
| SOLUSDT | FAIL -2.7% | FAIL -7.7% | FAIL -5.6% | -15.9% |
| XRPUSDT | FAIL (0トレード) | **PASS +25.5%** | PASS +0.8% | +26.3% |

### OOS通過戦略（3/9）

| Regime | Template | Exit | PnL | Trades | WR | Sharpe |
|--------|----------|------|-----|--------|-----|--------|
| XRP/downtrend | rsi_reversal | atr_tp20_sl20 | **+25.5%** | 23 | 60.9% | 3.27 |
| BTC/uptrend | volume_spike | atr_tp15_sl20 | +2.3% | 14 | 78.6% | 5.50 |
| XRP/range | volume_spike_short | atr_tp40_sl20 | +0.8% | 23 | 34.8% | 0.32 |

### 考察
- **XRP downtrend が突出**: RSI逆張りが下落トレンドで+25.5%（2年分で頑健）
- **SOL 全滅**: 2年分でも過学習を克服できず
- **推奨戦略 0件**: symbol_count=1（銘柄横断の汎用戦略は見つからず）
- **前回（1年 SMA 5銘柄）との比較**: OOS通過率 3/13→3/9。率は改善だが銘柄汎用性は低い
- **根本課題**: 「銘柄を問わず機能する戦略」は存在しにくい。銘柄固有のエッジを活かす方向性が現実的か

---

## 探索空間削減: exit profile コンパクト化

### 背景・課題
- 全exit 69パターン × 21テンプレート × パラメータ = 105,777コンボ/銘柄
- 探索空間が大きすぎて、trainで偶然ハマるパターンがベストに選ばれる
- OOSが正しく弾くが、結果として何も残らない
- **OOSは過学習を「検出」するだけで「防止」はしない**

### 実装: `atr_compact` モード
- `optimizer/exit_profiles.py` に `ATR_COMPACT_PROFILES` 追加
- SL=ATR×2.0固定（全テストで共通）、TP 3択（1.5, 2.0, 3.0）
- CLI: `--exit-profiles atr_compact`

### テスト結果（Run ID: 20260206_153712）

**条件**: 3銘柄(BTC,SOL,XRP) × 2年 × Dual-TF EMA × exit 3択
**実行時間**: 2.5分（前回25分→10倍高速化）、4,347コンボ/銘柄

| 銘柄 | Uptrend | Downtrend | Range |
|------|---------|-----------|-------|
| BTCUSDT | +0.4% PASS(微弱,2件) | -3.5% FAIL | -1.3% FAIL |
| SOLUSDT | -3.9% FAIL | **+4.9% PASS** | -5.6% FAIL |
| XRPUSDT | 0トレード | **+25.5% PASS** | **+7.1% PASS** |

OOS通過: 3/9 → **4/9**。SOL/downtrendがFAIL→PASSに転換。

### 過学習 防止 vs 検出 の学び
- **OOSだけに頼ると「全部弾かれて何も残らない」**
- 探索空間削減（69→3）で、trainのベストが本物のエッジである確率が上がる
- 両方必要: 防止（空間削減）+ 検出（OOS）

---

## 過学習防止ロードマップ

1. ~~探索空間を小さくする~~ ← 完了（exit 69→3）
2. **最低トレード数フィルタ** ← 次（トレード2件PASSは無意味）
3. **銘柄数を増やす（3→10+）** ← downtrendの横断検証
4. パラメータ数を減らす（テンプレート自由度制限）
5. WFA（ローリングウィンドウ検証）

---

## 参考: 前回OOS検証結果（2026-02-01）

- **Range + macd_signal_short**: 85%通過（最有力）
- **Downtrend + volume_spike_short**: 67%通過
- **Uptrend全般**: ほぼ全滅（過学習）

→ 全テストを通じて range > downtrend > uptrend の傾向が一貫。

---

## 2023年データダウンロード（ローカルセッション）

### 実施内容
- `scripts/download_2023_data.py` を作成・実行
- 期間: 2023/02-2024/01、TF: 15m, 1h, 4h（1m除外）
- 30銘柄中26銘柄成功（ENAUSDT, ONDOUSDT, RENDERUSDT, WIFUSDTは2023年未上場でデータなし）
- ファイル名に `-merged` サフィックス追加（scan_inputdataのパターンに合わせるため）
- inputdata合計: 314ファイル、4.5GB

### データ期間の全体像（3年分）
| 期間 | 銘柄数 | TF |
|------|--------|-----|
| 2023/02-2024/01 | 26 | 15m, 1h, 4h |
| 2024/02-2025/01 | 30 | 1m, 15m, 1h, 4h |
| 2025/02-2026/01 | 30 | 1m, 15m, 1h, 4h |

### コミット・プッシュ
- `8d7d559` feat: バッチ最適化にGA/ブラックリスト/採用スコア追加 + 2023年データDLスクリプト

### ブラックリスト
- GAでFAILした銘柄×レジーム×テンプレートの組み合わせを自動記録
- グリッドサーチ時にスキップすることで効率化
- ONにして実行するのが妥当

### 3期間グリッドサーチの注意点
- UIは複数期間対応済み（チェックボックス3つ表示される）
- データがない銘柄×期間は自動スキップ（エラーにならない）
- 3期間×30銘柄だとジョブ数3倍→実行時間注意

---

---

## Modal環境セットアップ（Mac）

- `pip3 install modal` でインストール（pyenv Python 3.13.1）
- `modal` コマンドはPATHに通らないので `python3 -m modal` を使う
- `python3 -m modal setup` でブラウザ認証（workspace: kh1985）
- Modal Volume に10銘柄×2年(20240201-20260130)×15m,1h,4h が全て揃っている

---

## Step 2: テンプレート固定横断テスト（本セッション実施）

### 2-A. 1年データ混合テスト（Run ID: 20260206_180815）
- 4候補テンプレート混合 × atr_compact × 10銘柄 × 1年
- 5銘柄がMA Cross fallback（4hデータなし）
- PASS: 6/30 (20%)

### 2-B. 2年データ混合テスト（Run ID: 20260206_181614）
- 4候補テンプレート混合 × atr_compact × 10銘柄 × 2年
- **全銘柄Dual-TF EMA対応**（70,080本/銘柄）
- PASS: 8/30 (26.7%)
- **downtrend 40% PASS** が最良（SOL, XRP, BNB, TRX）
- テンプレートは銘柄間で統一されず（rsi_reversal, vol_spike_short, ma_crossoverが混在）

### Step 3 判定
- **特定テンプレートで3銘柄以上PASS**: 未達（各2銘柄止まり）
- **「downtrendにエッジがある」は確定**だが、単体テンプレートの銘柄横断性は限界

---

## 複合テンプレート実装・テスト（本セッション実施）

### 実装した4テンプレート
1. `rsi_volume_reversal` — RSI<閾値 + RVOL>倍率 + 陽線 → ロング（9パターン）
2. `rsi_volume_reversal_short` — RSI>閾値 + RVOL>倍率 + 陰線 → ショート（9パターン）
3. `rsi_bb_reversal` — RSI<閾値 + close<BB下限 → ロング（3パターン）
4. `rsi_bb_reversal_short` — RSI>閾値 + close>BB上限 → ショート（3パターン）

**設計方針**: インジケーター期間は固定（RSI=14, RVOL=20, BB=20/2σ）、探索は閾値のみ
**コンボ数**: 72 configs/銘柄（単体の1/16）

### テスト結果（Run ID: 20260206_183526）
- 2年 × 10銘柄 × Dual-TF EMA × atr_compact
- PASS: 8/30 (26.7%) — 単体と同率

### 重要な発見: 複合条件が銘柄横断性の鍵

| テンプレート | PASS数 | PASS銘柄 |
|------------|--------|---------|
| **rsi_bb_reversal_short** | **6** | SOL/UT, SOL/range, DOT/UT, BNB/DT, ETH/range, XRP/range |
| rsi_bb_reversal | 2 | ADA/UT, AVAX/DT |
| rsi_volume_reversal | 0 | 全滅 |
| rsi_volume_reversal_short | 0 | 全滅 |

- **単体テンプレートでは最大2銘柄PASSが限界だったのに、rsi_bb_reversal_shortは6銘柄PASS**
- RSI + Volume は AND条件が厳しすぎてトレード数不足 → 過学習助長
- RSI + BB は適切なフィルタとして機能 → 銘柄横断性を実現
- ただしPnLは控えめ（PF 1.10-1.27）

### 結論
**「複数インジケーターの組み合わせ」が銘柄横断性の鍵**。
単体インジケーターの限界を突破するには、適切な組み合わせを探索していくのが正しい方向。

---

## 複合テンプレート第2弾（別スレ結果）

### テスト結果（Run ID: 20260206_185238）
- MACD+BB(2種) + Stoch+BB(2種) + RSI+MACD(2種) + BB+Volume(2種) × atr_compact × 10銘柄 × 2年
- PASS: 10/30 (33.3%) — 過去最高

| テンプレート | PASS数 | PASS銘柄 |
|------------|--------|---------|
| **bb_volume_reversal_short** | **5** | AVAX/UT, AVAX/DT, BTC/range, DOGE/range, ETH/range |
| bb_volume_reversal | 3 | BNB/UT, BNB/range, DOT/DT +26.6%, XRP/UT |
| stoch_bb/macd_bb/rsi_macd | 0 | 全滅 |

- **BBを含む組み合わせだけが機能** → BB が横断フィルタの鍵

---

## 3期間一貫性検証（本セッション夜）

### Modal Volumeデータ整備
- 2023年データ（10銘柄×15m,1h,4h）を新規取得
- 2024-2025年データ（10銘柄×15m,1h,4h）を新規取得
- 2025-2026年の不足5銘柄（ADA,AVAX,DOGE,DOT,TRX）も取得
- **Modal Volume: 10銘柄×3期間×3TF = 全90ファイル完備**

### テスト結果（Run ID: 20260206_191208）
- rsi_bb_reversal_short + bb_volume_reversal_short × atr_compact × 10銘柄 × **3年**(2023-2026)
- 全銘柄Dual-TF EMA対応、30ジョブ14秒完了
- **推奨戦略1件**: bb_volume_reversal_short / uptrend（4銘柄、OOS通過率50%）

### Top 5

| Regime | Template | OOS通過率 | 平均PnL | 銘柄数 |
|--------|----------|-----------|---------|--------|
| range | rsi_bb_reversal_short | 50% | +5.8% | 2 |
| downtrend | rsi_bb_reversal_short | 29% | +1.1% | 5 |
| uptrend | bb_volume_reversal_short | 50% | +0.3% | 4 |
| range | rsi_bb_reversal_short | 25% | -0.8% | 7 |
| uptrend | bb_volume_reversal_short | 43% | -1.8% | 6 |

### 考察
- rsi_bb_reversal_short/DT が3年間でも5銘柄に出現（2年の6銘柄から微減、想定通り）
- 3年間で複数銘柄に一貫して出現する戦略が**初めて推奨ランクに入った**
- PnLは控えめ → 閾値微調整で改善余地あり

---

## ローカルUI改善（本セッション夜）

### 追加した設定
- **optimizer_page.py**: Dual-TF EMA（4h+1h合意）を検出方法セレクトに追加 + super_htfセレクタ
- **batch_optimizer.py**: ATRコンパクト（推奨）をExit選択の先頭に追加 + トレンド検出方法セレクタ（デフォルトDual-TF EMA）

---

## 自動化: `/next-step` スキル実装（夜セッション後半）

### 背景
- ロードマップに沿って「結果分析→次パターン提案→Modal実行→ロードマップ更新」を毎回手動で進めていた
- ユーザー: 「skillsかhookか使えないか？なければclaude.mdがいいんだろうな」

### 実装したもの
1. **`.claude/skills/next-step.md`（新規）**: `/next-step` で起動するスキル
   - `status`: 現状把握のみ
   - 引数なし: 分析 + 次パターン提案
   - `run`: 提案→承認→Modal実行→ロードマップ更新まで一気通貫
   - BB系のみ有効、失敗パターン再テスト禁止の鉄則を組み込み
   - 判定ロジック（PASS率/PnLに応じて次アクション自動決定）

2. **`CLAUDE.md` 更新**: 「戦略探索ワークフロー（自動ガイド）」セクション追加
   - セッション開始時にロードマップ読んだら自動で現状報告
   - 探索の鉄則（BB必須、失敗パターン再テスト不要）

### 判断
- **Skills が最適**: ユーザーが `/next-step` と打つだけで手順書に沿って実行
- **Hooks は不向き**: ツール実行時のバリデーション用、ワークフロー駆動には向かない
- **CLAUDE.md**: セッション開始時の常時リマインドに使用

### VSCode対応追加
- VSCodeではスラッシュコマンドが使えない問題が発覚
- CLAUDE.mdを修正: 「next-step」「次のステップ」「次」等のキーワードで同じフローを起動するよう変更
- スラッシュ不要で動作する

---

## Step 6.5: 30銘柄スケール検証（夜セッション後半）

### Modal Volumeデータ拡張
- 10銘柄 → 30銘柄にデータ拡張
- 20銘柄の追加データ取得（3期間 × 3TF）
- 一部銘柄（RENDER, ENA, WIF, ONDO）は2023年データなし
- Modal Volume合計: 約285ファイル

### テスト結果（Run ID: 20260206_200522）
- 30銘柄 × 3年 × 2テンプレート × atr_compact × Dual-TF EMA
- 90ジョブ、27秒完了、85結果ファイル

### 推奨戦略 **2件**（スコア > 推奨閾値）

| Regime | Template | Exit | OOS通過率 | 平均PnL | 銘柄数 | Score |
|--------|----------|------|-----------|---------|--------|-------|
| **uptrend** | rsi_bb_reversal_short | atr_tp30_sl20 | **75%** | **+7.5%** | 4 | **0.739** |
| **range** | rsi_bb_reversal_short | atr_tp30_sl20 | **57%** | **+6.6%** | 7 | **0.649** |

### 重要な発見
- **rsi_bb_reversal_short が全3レジームでTop 3独占** → 真に銘柄横断的
- **atr_tp30_sl20（TP=ATR×3.0）が最適exit** — 10銘柄ではtp20→30銘柄でtp30に
- **uptrend 75% PASS** — 以前の「uptrend過学習」傾向を覆す
- **30銘柄に拡大してもパターン維持** → rsi_bb_reversal_shortの汎用性は本物
- bb_volume_reversal_short は rsi_bb に全レジームで劣後

---

## 30銘柄詳細分析（夜セッション第3部）

### 詳細レポート生成
- 85 JSONファイルを全て解析
- [OOS_DETAILED_TABLES.md](OOS_DETAILED_TABLES.md) — 銘柄×期間×レジームの全テーブル
- [OOS_ANALYSIS_SUMMARY.md](OOS_ANALYSIS_SUMMARY.md) — 分析レポート全文

### テンプレート×Exit 選択頻度（重要な発見）
- atr_tp15_sl20 が最頻出（50.6%）— trainでは保守的TPが好まれる
- atr_tp30_sl20 は9-11%しか選ばれない — が、選ばれた時のPASS率が最高
- → trainで選ばれにくいがOOSでロバスト = 過学習しにくい設定

### レジーム別ベスト（実PASS率ベース、n数考慮）

| レジーム | テンプレート | Exit | PASS率 | n |
|---------|------------|------|--------|---|
| **Downtrend** | rsi_bb_short | tp20 | **50%** | **16** |
| **Downtrend** | bb_vol_short | tp20 | **50%** | **10** |
| Range | bb_vol_short | tp20 | 63% | 8（nやや不足） |
| Uptrend | bb_vol_short | tp20 | 60% | 10（ショートでUT除外） |

### ユーザーの重要な判断: Uptrendショートは除外

- ショート戦略をUptrendで使うのは逆張り → リスクが高い
- データ上PASS率60%でも、実運用では心理的にもキツい
- **Uptrend結果は参考値として保持、実運用からは除外**

### OOS PASS率の判定基準（確定）

| PASS率 | 判定 |
|--------|------|
| < 30% | エッジなし（ベースライン27%） |
| 30-40% | ノイズの可能性 |
| 40-50% | 有望 |
| **50%+** | **実用レベル** |
| 60%+ | 強いエッジ |

サンプル数: n ≥ 10 が最低基準、n ≥ 20 で高い信頼性

### 期間一貫性
- RENDERUSDTがDT × rsi_bb × tp30 で2期間連続PASS（+7.0%, +16.4%）
- NEARUSDTがDT × bb_vol × tp15 で2期間連続PASS（+8.0%, +4.0%）
- ただし全体的に期間一貫性は限定的 → 銘柄横断の方が有望

---

## 今日の総括

### 探索の道のり
1. Step 1: 21テンプレート全投入 → PASS率27%、銘柄横断ゼロ
2. Step 2-3: テンプレート固定横断 → 最大2銘柄止まり
3. Step 4: **RSI+BB複合で6銘柄PASS** ← 突破口
4. Step 5: BB系だけが機能する法則を発見
5. Step 6: 10銘柄×3年一貫性 → 推奨1件（弱め）
6. Step 6.5: **30銘柄×3年 → DT 50% PASS（n=16）で統計的に確認**

### 確定した使えるパターン

| レジーム | 戦略 | Exit | PASS率 | n | 意味 |
|---------|------|------|--------|---|------|
| **Downtrend** | rsi_bb_short | tp20 | 50% | 16 | 下落中の戻り売り |
| **Downtrend** | bb_vol_short | tp20 | 50% | 10 | 下落中の出来高天井売り |

### 主要な学び
- **BBが銘柄横断フィルタの鍵** — 今日一番のブレイクスルー
- 単体テンプレートは最大2銘柄PASS → 複合で突破
- Stoch+BB, MACD+BB, RSI+MACD は全滅（BBと何でも組めばいいわけではない）
- tp20がバランス最良、tp30は選ばれにくいが選ばれた時は強い
- Uptrendでのショートは理論上不適切 → 除外判断

---

## 次回やること

### 最優先: Downtrend戦略の深掘り（Step 7）
- rsi_bb_short × tp20 のRSI閾値細分化（65/70/75/80）
- bb_vol_short × tp20 のRVOL閾値細分化（1.5/2.0/2.5/3.0/4.0）
- BB σ の調整（2.0/2.5/3.0）
- **30銘柄×3期間で再検証し、PASS率とn数を更に確認**

### Range検証の強化
- bb_vol_short × tp20 / Range が63%(n=8) — 有望だがn不足
- データ量を増やしてn ≥ 10 を目指す

### 候補
- 3重複合: RSI + BB + Volume（BBとVolumeの両方を組み合わせ）

### 未着手
- minaraai着想の新テンプレート（RSI7, EMA Crossover等）
- WFA（ローリングウィンドウ検証）
- ロング戦略の探索（現在はショートのみ）

---

## Step 7 実行結果（夜セッション第2部）

### Step 7b: パラメータ修正 + ロング版追加

**Run ID**: 20260206_221008
**条件**: 5テンプレート × atr_compact × 30銘柄 × 3年(2023-2026) × Dual-TF EMA
**実行時間**: 21秒（85結果ファイル、90ジョブ並列）

**テンプレート変更**:
- rsi_bb_reversal_short: σ=2.0固定に戻す、RSI 60/65/70/75（80除去）
- bb_volume_reversal_short: σ=2.0固定に戻す、RVOL 2.5/3.0/3.5/4.0（2.0除去）
- **新規追加**: rsi_bb_volume_reversal_short（RSI+BB+Volume 3重複合）
- **新規追加**: rsi_bb_reversal_long（ロング版）
- **新規追加**: bb_volume_reversal_long（ロング版）

### 推奨戦略

| Rank | Regime | Template | Exit | OOS通過率 | 平均PnL | Score |
|------|--------|----------|------|-----------|---------|-------|
| 1 | uptrend | **rsi_bb_reversal_long** | atr_tp30_sl20 | 50% | +16.4% | 0.723 |
| 2 | downtrend | bb_volume_reversal_short | atr_tp30_sl20 | 60% | +2.1% | 0.519 |

### 実運用候補（方向一致のみ、逆張り除外）

| テンプレート | レジーム | n | PASS | 率 |
|------------|--------|---|------|-----|
| **rsi_bb_reversal_long** | **uptrend** | **26** | **11** | **42.3%** |
| bb_volume_reversal_short | downtrend | 12 | 5 | 41.7% |
| rsi_bb_reversal_short | range | 17 | 5 | 29.4% |
| rsi_bb_reversal_short | downtrend | 19 | 5 | 26.3% |

### 重要な発見

1. **rsi_bb_reversal_long / uptrend が最大の収穫**
   - 11銘柄PASS（LINK +38.9%, SUI +36.5%, ARB +24.3%等）
   - ロング×上昇トレンド = 方向一致 → 理論的にも健全
   - BNBUSDT が2期間連続PASS（2024: +1.1%, 2025: +5.0%）

2. **3重複合（rsi_bb_volume_reversal_short）は完全失敗**
   - 55件中1件のみPASS（1.8%）→ 条件過剰でトレード機会激減
   - RSI+BB の2条件が最適、Volumeを追加すると壊れる

3. **bb_volume_reversal_short / downtrend が大幅改善**
   - Step 6.5: 15.0%(n=40) → Step 7b: 41.7%(n=12)
   - σ=2.0固定 + RVOL≥2.5 の絞り込みが有効

4. **atr_tp30_sl20 が優位確定**
   - Exit別PASS率: tp30=22.7%, tp20=17.4%, tp15=11.7%
   - 利確幅を広く取る方が期間横断で安定

### Step 6.5からの変化
- 最有望: DT×rsi_bb_short 50%(n=16) → **UT×rsi_bb_long 42.3%(n=26)**
- ショートのみ → **ロング版が浮上し最有力に**
- rsi_bb_short/DT のPASS率は安定（26.7% → 26.3%）
- 3重複合は除外確定

### 次のステップ候補
- rsi_bb_reversal_long のRSI閾値微調整（25-40の細分化）で50%到達を狙う
- bb_volume_reversal_short/DT のn増加
- BNBUSDTのような2期間一貫銘柄を増やす方法

---

## Step 7 詳細分析セッション（このセッションで実施）

### σ拡張の逆効果分析（Step 7a: Run 20260206_214905）

Step 7aで BB σ を 2.0/2.5/3.0 に拡張したところ、全面的に悪化:

| bb_std | 出現回数 | PASS率 |
|--------|---------|--------|
| **σ=2.0** | 126回 | **48.4%** |
| σ=2.5 | 118回 | 34.7% |
| σ=3.0 | 11回 | 36.4% |

**σ=2.5がトレーニングで選ばれるとOOSで13.7pt悪化** → σ=2.0固定が最適と確定。

パラメータ別:
- RSI=60-70がスイートスポット（PASS率44-45%）、RSI=80は0%で無意味
- RVOL=3.0-3.5がPASS率50%で最良、RVOL=2.0は25.7%で低すぎ

### σ=2.0固定版の再検証（Step 7b中間: Run 20260206_220851）

修正内容:
- rsi_bb_reversal_short: σ=2.0固定、RSI 60/65/70/75（80除去、4値×3exit=12 configs）
- bb_volume_reversal_short: σ=2.0固定、RVOL 2.5/3.0/3.5/4.0（2.0除去、4値×3exit=12 configs）

結果（推奨2件）:

| レジーム | テンプレート | Exit | OOS通過率 | 平均PnL | 銘柄数 |
|---------|------------|------|---------|---------|--------|
| Range | rsi_bb_short | tp30 | **62%** | +7.0% | 7 |
| Uptrend | rsi_bb_short | tp30 | **50%** | +6.5% | 8 |

σ修正の効果:
- DT × rsi_bb × tp20: 18%(Step7a) → **46%** (+28pt)
- Range × rsi_bb × tp30: 50%(Step7a) → **62%** (+12pt)
- DT × rsi_bb × tp30: 23%(Step7a) → **40%** (+17pt)

→ σ=2.0固定で全面改善。この結果を踏まえて別セッションでロング版追加の本番Step 7b(Run 20260206_221008)が実行された。

### 核心的学び
- **パラメータ空間を広げる ≠ 改善**。過学習の余地が増えてOOSが悪化する
- **σ=2.0固定が最適解**（BB幅のチューニングは不要と確定）
- **RVOL=2.0を除外**することでbb_vol_short/DTが15%→42%に大幅改善
