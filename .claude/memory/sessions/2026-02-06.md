# 2026-02-06 セッションログ

## minaraai自動取引ログの分析

ユーザーがminaraai（自動取引AI）の判断ログを持ち込み、Prismに活かせないか検討。

### minaraaiのロジック概要

- **マルチTF統合判断**: 4H（トレンド方向）→ 15m（エントリータイミング）→ 3m（精度）
- **使用インジケーター**: EMA20/50, MACD, RSI7/RSI14, Volume, OI, Funding Rate
- **判断フレームワーク**:
  1. Sharpe Ratioで実行モード切替（低い→保守的、高い→攻める）
  2. 既存ポジション確認 → 新規シグナル検出
  3. 銘柄別に信頼度スコア（0-100）を算出、閾値≥70で実行
  4. 条件未達なら「待つ」判断が可能
- **対象**: BTC, ETH, SOL（3銘柄同時監視）
- **分析時の状況**: 全3銘柄が4H下落トレンド内で15m反発中 → 全銘柄「待ち」判断

### Prism vs minaraai 比較結論

| 領域 | Prismが強い | minaraaiが強い |
|------|------------|---------------|
| 戦略探索 | 21テンプレート × グリッド/GA × exit profiles | 固定ロジック1つ |
| 過学習検出 | OOS/WFA/CV | なし |
| 統計的検証 | 30銘柄横断バッチ | 3銘柄個別 |
| リアルタイム判断 | なし（バックテストのみ） | 即時売買判断 |
| 複合条件の質 | 瞬間スナップショット | 状態の推移を読む |
| 「待つ」判断 | なし（条件合えば常にエントリー） | 信頼度閾値で見送り可 |
| OI/Funding | 未対応 | 判断材料として使用 |

**本質**: Prism=研究者（統計的発見）、minaraai=トレーダー（リアルタイム文脈判断）。補完関係。

---

## Modal本番実行 & 結果分析

### 実行概要
- **Run ID**: 20260206_105242
- **5銘柄 × OOS × 全exit profiles**: 528,885コンボ（各105,777）
- **実行時間**: 738秒（12.3分）
- **ローカル推定**: 3時間 → Modal 5並列で約5倍高速

### 5銘柄分析結果

| 銘柄 | Uptrend | Range | Downtrend | ベスト |
|------|---------|-------|-----------|--------|
| BTCUSDT | FAIL | FAIL | FAIL | なし |
| ETHUSDT | FAIL | PASS +0.7% | FAIL | range/volume_spike_short |
| BNBUSDT | PASS +0.29% | PASS +1.5% | PASS +4.04% | **downtrend/ma_crossover** |
| SOLUSDT | FAIL | FAIL | PASS +0.12% | ほぼゼロ |
| XRPUSDT | FAIL | PASS +3.30% | FAIL | range/stochastic_reversal_short |

### 主要な発見
- **レジーム傾向**: range > downtrend > uptrend（2/1結果と一致）
- **bb_exit_atr_sl20** がOOS通過した2戦略で共通 → 信頼できるexit profile候補
- **BTC/ETH**: エッジ発見が最も難しい（流動性高い＝非効率性少ない）
- **BNB**: 唯一3レジーム全通過（中規模アルトの特性か）
- **推奨戦略**: ランキングで0件（銘柄数1のため推奨基準未達）

---

## Modal直接データ取得スクリプト実装

### `scripts/modal_fetch_data.py`（新規作成）
- Binance data.binance.vision → Modal Volume に直接ダウンロード
- ローカルCSVダウンロードが不要に
- 銘柄ごとに`.spawn()`で並列実行
- `--list`フラグでVolume内の既存データ確認可能

### 完全クラウドワークフロー
```
modal run scripts/modal_fetch_data.py     # データ取得（Binance → Volume）
modal run scripts/modal_optimize.py       # 最適化実行
modal run scripts/modal_download.py       # 結果DL
```

---

## Modalスクリプト一覧

| スクリプト | 用途 |
|-----------|------|
| `scripts/modal_fetch_data.py` | Binance → Modal Volumeに直接データDL |
| `scripts/modal_upload.py` | ローカルCSV → Modal Volumeアップロード |
| `scripts/modal_optimize.py` | Modal上でバッチ最適化実行 |
| `scripts/modal_download.py` | Modal Volume → ローカルに結果DL |

### Windows注意点
- Pythonパス: `C:\Users\k-hachiya\AppData\Local\Programs\Python\Python312\python.exe`
- cp932エンコーディング問題: `PYTHONUTF8=1 PYTHONIOENCODING=utf-8` を付ける

---

## Dual-TF EMA レジーム検出 実装

### 背景
- minaraaiの3層TF分析（4H→15m→3m）に触発
- 従来の1h SMA20/50 のみのレジーム判定はノイジーで、OOS通過率が低い
- 4hと1hの両方で方向が一致した場合のみトレンドと判定する方式を導入

### 実装内容（コミット: `2c4faff`）
- **`analysis/trend.py`**: `detect_dual_tf_ema()` メソッド追加
  - 4h EMA20/50 方向 + 1h EMA20/50 方向
  - 両方 up → uptrend、両方 down → downtrend、不一致 → range
  - `pd.merge_asof` で 4h→1h ラベル伝播（ルックアヘッド防止）
- **`scripts/modal_optimize.py`**: `--super-htf` オプション追加（デフォルト: `4h`）
  - 4hデータなし時は従来の MA Cross にフォールバック

### EMA vs SMA の選択理由
- EMAの方がトレンド反応が速い
- SMAのrange_threshold_pct=0.1%は狭すぎた → Dual-TFでは不一致=rangeで自然に判定

### Parabolic SAR を採用しなかった理由
- SARはup/downの2択のみ（rangeが定義できない）
- レンジ相場で高速フリップしてチャタリング発生
- レジーム分類にはEMAが適切（SARはエントリー/エグジットタイミング向き）

---

## Dual-TF EMA テスト結果（Run ID: 20260206_140419）

### 条件
- **期間**: 2年分（2024-02 〜 2026-01）
- **銘柄**: BTC, SOL, XRP（BTCと値動きが異なるアルト2銘柄を選定）
- **TF**: 15m実行 / 1h+4h レジーム / OOS ON / 全exit profiles
- **実行時間**: 25.1分（3銘柄 × 105,777コンボ）

### OOS結果

| 銘柄 | Uptrend | Downtrend | Range | 合計PnL |
|------|---------|-----------|-------|---------|
| BTCUSDT | PASS +2.3% | FAIL -0.4% | FAIL -3.5% | -1.6% |
| SOLUSDT | FAIL -2.7% | FAIL -7.7% | FAIL -5.6% | -15.9% |
| XRPUSDT | FAIL (0トレード) | **PASS +25.5%** | PASS +0.8% | +26.3% |

### 考察
- **XRP downtrend が突出**: RSI逆張りが下落トレンドで+25.5%（2年分で頑健）
- **SOL 全滅**: 2年分でも過学習を克服できず
- **推奨戦略 0件**: symbol_count=1（銘柄横断の汎用戦略は見つからず）

---

## 探索空間削減: exit profile コンパクト化

### 実装: `atr_compact` モード
- `optimizer/exit_profiles.py` に `ATR_COMPACT_PROFILES` 追加
- SL=ATR×2.0固定（全テストで共通）、TP 3択（1.5, 2.0, 3.0）
- CLI: `--exit-profiles atr_compact`

### テスト結果（Run ID: 20260206_153712）
**条件**: 3銘柄(BTC,SOL,XRP) × 2年 × Dual-TF EMA × exit 3択
OOS通過: 3/9 → **4/9**。SOL/downtrendがFAIL→PASSに転換。

### 過学習 防止 vs 検出 の学び
- **OOSだけに頼ると「全部弾かれて何も残らない」**
- 探索空間削減（69→3）で、trainのベストが本物のエッジである確率が上がる
- 両方必要: 防止（空間削減）+ 検出（OOS）

---

## 汎用戦略探索ロードマップ策定

### 背景
ユーザーが「行き当たりばったりで進めてないか？」と指摘。構造的なロードマップを策定。

### パイプラインの盲点発見
- 全21テンプレート混合でOOSテストすると、各銘柄で「一番勝った」テンプレートだけがOOS検証される
- 特定テンプレートが他銘柄でも機能するかは**テストされていない**
- 例: rsi_reversalがXRPとADAで通過 → 他8銘柄ではrsi_reversalは一度もOOSテストされていない

### ロードマップ構造
- **Step 1**: ベースライン（全テンプレート混合）→ 完了
- **Step 2**: テンプレート固定横断テスト → 完了
- **Step 3**: 判定（3銘柄以上PASS → エッジ確定）→ 完了
- **Step 4**: 複合テンプレート（必要時のみ）→ 未着手（不要になった）
- 管理ファイル: `.claude/memory/roadmap.md`

---

## Step 2: テンプレート固定 横断テスト — 完了

### 実行
4テンプレートを1つずつ固定し、全10銘柄で強制OOSテスト:
- `rsi_reversal` (Run ID: 20260206_164546)
- `volume_spike_short` (Run ID: 20260206_164548)
- `ma_crossover` (Run ID: 20260206_164550)
- `bb_bounce` (Run ID: 20260206_164551)

### 結果: 5つのエッジ候補発見

| Rank | テンプレート | レジーム | PASS数 | PASS銘柄 | 平均PnL |
|------|-------------|---------|--------|---------|---------|
| **1** | **volume_spike_short** | **downtrend** | **6/10** | ADA(+15.1%),DOT(+10.5%),XRP(+6.5%),TRX(+5.2%),SOL(+2.8%),AVAX(+1.5%) | **+6.9%** |
| **2** | **volume_spike_short** | **range** | **4/10** | DOGE(+11.1%),SOL(+8.9%),XRP(+7.1%),DOT(+2.2%) | **+7.3%** |
| **3** | **ma_crossover_short** | **uptrend** | **4/10** | AVAX(+6.1%),ETH(+3.9%),XRP(+2.5%),BNB(+0.6%) | **+3.3%** |
| 4 | rsi_reversal_short | range | 3/10 | ETH,XRP,DOGE | +1.9% |
| 5 | bb_bounce_short | range | 3/10 | ETH,SOL,XRP | +2.6% |

### 最重要発見
- **volume_spike_short / downtrend が6銘柄でOOS PASS** — 過去最強の横断エッジ
  - BNB(+7.0%,13件)とETH(+3.1%,17件)もプラスだがトレード数不足。実質8/10がプラス
- **上位5件すべてショート系テンプレート** — ロング系は横断性が低い
- **BTCだけが全テンプレート全レジームでFAIL** — 流動性最高=非効率性最小の仮説を強く裏付け

---

## min_oos_trades フィルタ実装

### 変更内容（scripts/modal_optimize.py、未コミット）
- `main()` に `min_oos_trades: int = 20` パラメータ追加
- OOS PASS条件: PnL > 0 **AND** trades >= 20
- `generate_ranking()` に伝播、config_infoにも記録

---

## 参考: 前回OOS検証結果（2026-02-01）

- **Range + macd_signal_short**: 85%通過（最有力）
- **Downtrend + volume_spike_short**: 67%通過
- **Uptrend全般**: ほぼ全滅（過学習）

→ 全テストを通じて range > downtrend > uptrend の傾向が一貫。

---

## 2023年データダウンロード（ローカルセッション）

### 実施内容
- `scripts/download_2023_data.py` を作成・実行
- 期間: 2023/02-2024/01、TF: 15m, 1h, 4h（1m除外）
- 30銘柄中26銘柄成功（ENAUSDT, ONDOUSDT, RENDERUSDT, WIFUSDTは2023年未上場でデータなし）
- ファイル名に `-merged` サフィックス追加（scan_inputdataのパターンに合わせるため）
- inputdata合計: 314ファイル、4.5GB

### データ期間の全体像（3年分）
| 期間 | 銘柄数 | TF |
|------|--------|-----|
| 2023/02-2024/01 | 26 | 15m, 1h, 4h |
| 2024/02-2025/01 | 30 | 1m, 15m, 1h, 4h |
| 2025/02-2026/01 | 30 | 1m, 15m, 1h, 4h |

### コミット・プッシュ
- `8d7d559` feat: バッチ最適化にGA/ブラックリスト/採用スコア追加 + 2023年データDLスクリプト

### ブラックリスト
- GAでFAILした銘柄×レジーム×テンプレートの組み合わせを自動記録
- グリッドサーチ時にスキップすることで効率化
- ONにして実行するのが妥当

### 3期間グリッドサーチの注意点
- UIは複数期間対応済み（チェックボックス3つ表示される）
- データがない銘柄×期間は自動スキップ（エラーにならない）
- 3期間×30銘柄だとジョブ数3倍→実行時間注意

---

## 次回やること

### 最優先: WFA検証
- **volume_spike_short / downtrend** をWalk-Forward Analysisで時間的頑健性検証
- PASSしたら戦略パラメータを保存（YAML）して実運用パイプラインへ

### 未コミット変更
- `scripts/modal_optimize.py`: min_oos_trades パラメータ追加
- `.claude/memory/roadmap.md`: ロードマップ管理ファイル新規作成

### ローカル環境
- 3年分データでグリッドサーチを実行（全銘柄×全期間）
- ユニバーサル戦略の3年分検証
- 下落トレンド銘柄横断仮説の検証（未着手）

### 未着手
- minaraai着想の新テンプレート（RSI7, EMA Crossover等）
- テンプレートの複合条件化（AND条件追加）
