Backtest System v2 - 開発・検証ログ
=====================================

日付: 2026-01-30

--- Phase 1~3: 実装 ---

v1（既存）のバックテストシステムに対して、以下のv2機能を実装した。

追加機能:
  1. Binance Data CSV/ZIPローダー（data.binance.visionのデータ読み込み）
  2. トレンドレジーム検出（MA Cross / ADX / Combined、上位TFで判定）
  3. 6種の戦略テンプレート（MA Crossover, RSI Reversal, BB Bounce, MACD Signal, Volume Spike, Stochastic Reversal）
  4. グリッドサーチ自動最適化エンジン（インジケーターキャッシュ付き）
  5. 複合スコアリング（Profit Factor, Win Rate, Max DD, Sharpe の重み付け）
  6. Streamlit Optimizerページ（設定 + 結果比較ダッシュボード）

新規ファイル: 14ファイル
修正ファイル: 5ファイル
合計: 54ファイル、5,608行

--- データダウンロード ---

Binance data.binance.vision から以下のデータをダウンロードした。

対象シンボル: WLDUSDT, BTCUSDT
期間: 2025-12-28 ~ 2026-01-28（Jan 29-30はBinance側で未公開のためなし）
タイムフレーム: 1m, 15m, 1h, 4h

バー数（各シンボル共通）:
  - 1m:  46,080 bars
  - 15m:  3,072 bars
  - 1h:    768 bars
  - 4h:    192 bars

ダウンロードスクリプト: scripts/download_binance.py
保存先: sample_data/binance/

注意: Binanceデータは16桁マイクロ秒タイムスタンプ。
binance_loader.pyで桁数を自動判定（us/ms/s）して変換する修正を行った。

--- GitHub Push ---

リポジトリ: https://github.com/kh1985/backtest-system (private)
ブランチ: master
コミット: 54ファイル / 5,608行

--- Optimizer実行・検証（WLDUSDT） ---

設定:
  - Execution TF: 1m（46,080バー）
  - Higher TF: 15m（トレンド判定用）
  - Detection Method: MA Cross（SMA20 vs SMA50）
  - テンプレート: 6種すべて選択
  - パラメータ: デフォルト範囲
  - Initial Capital: 10,000
  - Commission: 0.04%
  - Slippage: 0%
  - Scoring Weights: PF 0.30 / Win Rate 0.30 / Max DD 0.20 / Sharpe 0.20
  - Total: 99テンプレート × 3レジーム = 297 runs

結果トップ10:

  #0  rsi_reversal  rsi_period=20, rsi_threshold=20   range       score=0.6794  trades=11  WR=63.6%  PF=3.11  PnL=9.12%   DD=2.41%  Sharpe=9.12
  #1  rsi_reversal  rsi_period=25, rsi_threshold=20   range       score=0.6721  trades=8   WR=62.5%  PF=2.96  PnL=6.36%   DD=2.15%  Sharpe=8.69
  #2  volume_spike  rvol_period=10, rvol_threshold=6   range       score=0.6212  trades=11  WR=54.5%  PF=2.13  PnL=6.12%   DD=3.21%  Sharpe=5.91
  #3  rsi_reversal  rsi_period=15, rsi_threshold=30   downtrend   score=0.613   trades=31  WR=54.8%  PF=2.04  PnL=15.65%  DD=6.31%  Sharpe=5.43
  #4  rsi_reversal  rsi_period=30, rsi_threshold=30   downtrend   score=0.6124  trades=17  WR=52.9%  PF=2.0   PnL=8.64%   DD=3.21%  Sharpe=5.39
  #5  rsi_reversal  rsi_period=15, rsi_threshold=25   downtrend   score=0.6032  trades=25  WR=52.0%  PF=1.93  PnL=12.0%   DD=5.28%  Sharpe=5.08
  #6  rsi_reversal  rsi_period=10, rsi_threshold=20   downtrend   score=0.6032  trades=25  WR=52.0%  PF=1.93  PnL=12.0%   DD=5.28%  Sharpe=5.08
  #7  rsi_reversal  rsi_period=20, rsi_threshold=35   downtrend   score=0.6029  trades=30  WR=53.3%  PF=1.91  PnL=13.77%  DD=6.31%  Sharpe=4.94
  #8  rsi_reversal  rsi_period=20, rsi_threshold=30   downtrend   score=0.6024  trades=27  WR=51.9%  PF=1.91  PnL=12.84%  DD=5.28%  Sharpe=5.04
  #9  rsi_reversal  rsi_period=10, rsi_threshold=25   downtrend   score=0.6024  trades=30  WR=53.3%  PF=1.91  PnL=13.73%  DD=6.31%  Sharpe=4.92

--- 結果の考察 ---

ベスト戦略:
  rsi_reversal（RSI period=20, threshold=20）、rangeレジーム
  → RSI(20)が20を下回ったらロングエントリー、TP+2%/SL-1%で決済
  → 1ヶ月で11トレード、勝率63.6%、PF 3.11、Sharpe 9.12

戦略の意味:
  レンジ相場で売られすぎ（RSI<20）になったタイミングでロング。
  レンジでは価格が一定幅で上下するため、反発で利確に届きやすい。
  TP/SLのリスクリワード比1:2で、勝率63.6%なので期待値が高い。

レジーム別の傾向:
  - range: RSI逆張りが最も有効。少ないトレードだが高勝率・高PF。
  - downtrend: RSI逆張りが一定のPF（2.0前後）。トレード数多め、DDも大きい。
  - uptrend: ほとんどの戦略が機能しなかった。
    → 今回のテンプレートが全てロング逆張り系のため、
       上昇トレンドではRSI<20になる場面自体がほぼなかった。

散布図の特徴:
  - 右上（高PF・高WR）にrangeの青点が2つ突出
  - downtrend（赤）はPF 1.0~2.0、WR 50~55%に集中
  - uptrend（緑）は左下の原点付近に密集（PF≒0、WR≒0）

トレンド判定ロジック（今回使用）:
  MA Cross方式。上位TF（15m）のSMA20とSMA50を比較。
  - SMA20 > SMA50 → Uptrend
  - SMA20 < SMA50 → Downtrend
  - |SMA20 - SMA50| / close < 0.1% → Range
  上位TFのラベルをpd.merge_asof(backward)で1m足にforward-fill。

--- UI修正 ---

Data LoaderのDisplay barsスライダーの上限2000制限を撤廃。
全バー数まで表示可能に変更。（ただし大量バーはブラウザが重くなる可能性あり）
