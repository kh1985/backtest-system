# 要件定義: Prism

## システム概要

仮想通貨のスキャルピング〜デイトレード向け戦略を、バックテスト＋グリッドサーチで自動発見するシステム。

## アーキテクチャ

```
Binance CSV/ZIP → データ読込 → トレンドレジーム検出(HTF)
                                        ↓
              テンプレート × パラメータ × レジーム → グリッドサーチ(並列)
                                        ↓
              複合スコアでランキング → 過学習チェック → JSON保存
                                        ↓
              バッチ実行(複数銘柄) → コンセンサス分析 → クロスバリデーション
```

## コア要件

### バックテストエンジン
- Bar-by-barシミュレーション（先読みバイアスなし）
- TP/SL/トレーリングストップ/タイムアウト決済
- 手数料(0.04%)・スリッページ対応
- Numba JITによる高速化（1分足数十万行対応）

### 自動最適化
- 14テンプレート（6ロング+6ショート+2プルバック）のグリッドサーチ
- 3レジーム別最適化（Uptrend/Downtrend/Range）
- 複合スコア: `PF×w1 + WR×w2 + (1-DD)×w3 + Sharpe×w4 + Return×w5`
- インジケーターキャッシュ＋並列実行(1-8ワーカー)

### 過学習検出
- 警告フラグ: PF>2.0 / Sharpe>3.0 / トレード数<30 / OOS劣化>50%
- ウォークフォワード分析（Anchored WFA, IS/OOS複数フォールド）
- クロスバリデーション（銘柄横断の汎化性テスト）

### レジーム検出
- 上位TFからUptrend/Downtrend/Rangeを判定
- 3方式: MA Cross / ADX / Combined
- `merge_asof()`で先読み防止

## 要求→要件 対応表

| 要求 | 要件 | 実装状態 |
|------|------|---------|
| 勝てるパターンを自動で見つけたい | 14テンプレート×グリッドサーチ×レジーム別最適化 | 済 |
| 過学習を見抜きたい | 警告フラグ+WFA+クロスバリデーション | 済 |
| レジーム別に戦略を分けたい | HTFレジーム検出→レジーム別ランキング | 済 |
| 複数銘柄で検証したい | バッチ最適化+コンセンサス分析 | 済 |
| 高速に処理したい | Numba JIT+ベクトル化+並列実行 | 済 |
| 結果を後から見返したい | JSON/CSV保存・再読込 | 済 |

## 未実装ロードマップ

| 優先度 | 項目 | 根拠 |
|--------|------|------|
| Critical | データ3分割(Train/Val/Test)の自動化 | グリッドサーチ結果をそのまま信じるのはデータスヌーピング |
| Critical | OOS自動検証（テストデータでの1回限り最終評価） | backtesting_principles.md §7.1 |
| Important | BT→FW劣化率の可視化 | バックテストで良すぎる結果は疑え |
| Important | データ品質チェック（欠損バー、異常値） | backtesting_principles.md §3.1 |

## 技術スタック

Python 3.10+ / Streamlit / Plotly / pandas+numpy / Numba / ccxt / PyYAML

---
Version: v2.0（20260203）
