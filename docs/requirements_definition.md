# 要件定義: Prism

## システム概要

仮想通貨のスキャルピング〜デイトレード向け戦略を、バックテスト＋グリッドサーチで自動発見するシステム。

## アーキテクチャ

```
Binance CSV/ZIP → データ読込 → トレンドレジーム検出(HTF)
                                        ↓
              テンプレート × パラメータ × レジーム → グリッドサーチ(並列)
                                        ↓
              複合スコアでランキング → 過学習チェック → JSON保存
                                        ↓
              バッチ実行(複数銘柄) → コンセンサス分析 → クロスバリデーション
```

## コア要件

### バックテストエンジン
- Bar-by-barシミュレーション（先読みバイアスなし）
- TP/SL/トレーリングストップ/タイムアウト決済
- 手数料(0.04%)・スリッページ対応
- Numba JITによる高速化（1分足数十万行対応）

### 自動最適化
- 14テンプレート（6ロング+6ショート+2プルバック）のグリッドサーチ
- 3レジーム別最適化（Uptrend/Downtrend/Range）
- 複合スコア: `PF×w1 + WR×w2 + (1-DD)×w3 + Sharpe×w4 + Return×w5`
- インジケーターキャッシュ＋並列実行(1-8ワーカー)

### 過学習検出
- 警告フラグ: PF>2.0 / Sharpe>3.0 / トレード数<30 / OOS劣化>50%
- ウォークフォワード分析（Anchored WFA, IS/OOS複数フォールド）
- クロスバリデーション（銘柄横断の汎化性テスト）

### レジーム検出
- 上位TFからUptrend/Downtrend/Rangeを判定
- 3方式: MA Cross / ADX / Combined
- `merge_asof()`で先読み防止

## 要求→要件 対応表

| 要求 | 要件 | 実装状態 |
|------|------|---------|
| 勝てるパターンを自動で見つけたい | 14テンプレート×グリッドサーチ×レジーム別最適化 | 済 |
| 過学習を見抜きたい | 警告フラグ+WFA+クロスバリデーション | 済 |
| レジーム別に戦略を分けたい | HTFレジーム検出→レジーム別ランキング | 済 |
| 複数銘柄で検証したい | バッチ最適化+コンセンサス分析 | 済 |
| 高速に処理したい | Numba JIT+ベクトル化+並列実行 | 済 |
| 結果を後から見返したい | JSON/CSV保存・再読込 | 済 |

## 未実装ロードマップ

| 優先度 | 項目 | 根拠 |
|--------|------|------|
| Critical | データ3分割(Train/Val/Test)の自動化 | グリッドサーチ結果をそのまま信じるのはデータスヌーピング |
| Critical | OOS自動検証（テストデータでの1回限り最終評価） | backtesting_principles.md §7.1 |
| Important | BT→FW劣化率の可視化 | バックテストで良すぎる結果は疑え |
| Important | データ品質チェック（欠損バー、異常値） | backtesting_principles.md §3.1 |

---

## 改造案

### 改造案1: 出来高加味BB逆張り戦略

**背景**: ユーザーが過去に勝っていた手法の再現。「回転数（出来高）による底硬さ」を見てエントリーする。

**コンセプト**:
- 出来高を相対値（RVOL）で評価し、流動性のあるバーのみエントリー対象
- BB ±2σで逆張り、レジームに応じて方向を決定

**エントリーロジック**:

| レジーム | 条件 | 方向 | 狙い |
|---------|------|------|------|
| 上昇トレンド | BB -2σ + RVOL > 閾値 | ロング | 押し目買い |
| 下降トレンド | BB +2σ + RVOL > 閾値 | ショート | 戻り売り |
| レンジ | BB -2σ + RVOL > 閾値 | ロング | 下限逆張り |
| レンジ | BB +2σ + RVOL > 閾値 | ショート | 上限逆張り |

**エグジット**: BB反対側（-2σ→+2σ、+2σ→-2σ）または TP/SL

**パラメータ候補**:
- BB期間: 20（標準）
- BB標準偏差: 2.0
- RVOL期間: 20
- RVOL閾値: 1.0〜2.0（グリッドサーチ対象）

**実装タスク**:
- [ ] エントリー条件にRVOL閾値を追加
- [ ] BB反対側到達でのエグジット条件追加
- [ ] レジーム別テンプレート作成（bb_rvol_long / bb_rvol_short / bb_rvol_range_long / bb_rvol_range_short）

---

### 改造案2: VPVR + TPO + VWAP による価格帯分析

**背景**: 改造案1をさらに強化。「底の硬さ」を価格帯別の出来高・滞在時間で判定する。

**新規インジケーター**:

| 指標 | 計算 | 用途 | 実装状態 |
|------|------|------|---------|
| VWAP | Σ(価格×出来高) / Σ(出来高) | 出来高加重平均価格。割安/割高判定 | 実装済み |
| VPVR | 価格帯別の出来高分布 | POC（出来高最大の価格帯）= 硬いサポレジ | 未実装 |
| TPO | 価格帯別のバー滞在数 | POC（滞在時間最大の価格帯）= 硬いサポレジ | 未実装 |

**コンセプト**:
- VPVR POC ≒ TPO POC → 出来高も時間も集中 → 鉄板ゾーン
- 乖離してる → どっちかがフェイク、信頼度低い

**エントリーロジック強化版**:
```
改造案1の条件
  + 価格 < VWAP（割安確認）
  + 価格が VPVR POC 付近（出来高集中ゾーン）
  + VPVR POC ≒ TPO POC（時間も集中）
→ 鉄板エントリー
```

**パラメータ候補**:
- VPVR/TPO 計算期間: 50〜200本
- 価格ビン幅: 0.1%〜0.5%
- POC付近判定: ±0.5%〜±1.0%

**実装タスク**:
- [ ] VPVRインジケーター実装（価格帯別出来高集計）
- [ ] TPOインジケーター実装（価格帯別バー数集計）
- [ ] POC / VAH / VAL の算出
- [ ] エントリー条件に「価格がPOC付近」を追加
- [ ] VPVR POC と TPO POC の乖離チェック

**注意**: 毎バーでrolling計算すると重い。Numba化 or キャッシュ戦略が必要。

## 技術スタック

Python 3.10+ / Streamlit / Plotly / pandas+numpy / Numba / ccxt / PyYAML

---
Version: v2.0（20260203）
