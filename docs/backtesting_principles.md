# バックテスト基盤思想ドキュメント

> Prism の開発・運用において「エッジがあると錯覚しない」ための原則集。
> 6つの専門資料を統合し、本プロジェクトに適用可能な形式でまとめる。

---

## 1. バックテストで自分を騙す8つのバイアス

出典: [FX Replay - Backtesting Biases](https://www.fxreplay.com/learn/backtesting-biases-how-traders-fool-themselves-without-knowing-it)

| # | バイアス | 何が起きるか | Prism での対策 |
|---|---------|-------------|---------------|
| 1 | **後知恵バイアス** | チャートを見れば「ここで買えた」と思うが、リアルタイムでは判断できなかった | Bar-by-bar シミュレーション（現状実装済み）。未来データは参照不可 |
| 2 | **データスヌーピング** | パラメータを大量に試して「当たり」を選ぶ。100通り試せば偶然当たるものがある | グリッドサーチ後に **Out-of-Sample 検証を必須化**（→ 未実装、要対応） |
| 3 | **チェリーピッキング** | 都合の良いトレードだけ記録し、負けを無視する | 全トレード自動記録（現状実装済み） |
| 4 | **先読みバイアス** | 「このローソク足が確定する前に」エントリーするコードバグ | 確定足でのみシグナル判定（要コードレビュー確認） |
| 5 | **確証バイアス** | 「この戦略は勝てる」と信じたい気持ちで、負けデータを軽視する | 最低100トレード以上で判断。感覚ではなく数値（WR, PF, DD, Sharpe）で評価 |
| 6 | **選択バイアス** | 「トレンド相場だけ」など都合の良い期間でテストする | レジーム検出でUptrend/Downtrend/Range全てで検証（現状実装済み） |
| 7 | **生存者バイアス** | 今生き残ってる銘柄だけでテストし、潰れた銘柄を無視する | 複数銘柄でバッチ実行（現状実装済み）。ただし上場廃止銘柄は未対応 |
| 8 | **直近バイアス** | 直近5-10トレードの結果で戦略を変えてしまう | 統計的に有意なサンプルサイズでのみ判断する規律 |

---

## 2. バックテストの4大トラップ

出典: [LuxAlgo - Backtesting Traps](https://www.luxalgo.com/blog/backtesting-traps-common-errors-to-avoid/)

### 2.1 オーバーフィッティング検出の閾値

| 指標 | 警戒ライン | 意味 |
|------|-----------|------|
| Profit Factor | > 2.0 | 良すぎる。過去データに合いすぎてる可能性 |
| Sharpe Ratio | > 3.0 | 現実離れ。ノイズにフィットしてる疑い |
| Sortino Ratio | > 3.0 | 同上 |

**Prism への適用**: 複合スコアリングでこれらの閾値を超えた結果に ⚠️ 警告フラグを立てる仕組みを追加すべき。

### 2.2 実行コストの現実

バックテストと実運用の乖離の最大要因は**実行コスト**:
- **手数料**: 片道 0.04%（Prism 現状設定）
- **スリッページ**: 板の薄い銘柄ほど大きい。2%未満をシミュレーションに組み込む
- **市場インパクト**: 大きなポジションは価格を動かしてしまう

**Prism への適用**: 手数料は実装済み。スリッページは % ベースで設定可能にすべき（→ 要確認）。

### 2.3 市場環境の変化（レジームシフト）

同じ戦略でもレジームで結果が全く変わる:

| 要因 | 強気相場 | 弱気相場 |
|------|---------|---------|
| モメンタム | 効きにくい | 効きやすい |
| バリュー | 中程度 | 強い |
| 流動性 | プラス | マイナス |

**Prism への適用**: レジーム検出（MA Cross / ADX / Combined）は実装済み。レジーム別の結果比較も可能。ここは強み。

---

## 3. AI × 仮想通貨バックテストの実践ガイド

出典: [3Commas - Comprehensive Guide](https://3commas.io/blog/comprehensive-2025-guide-to-backtesting-ai-trading)

### 3.1 データ品質チェックリスト

- [ ] タイムスタンプの一貫性（欠損バーがないか）
- [ ] 出来高データの信頼性（ウォッシュトレードの除外）
- [ ] 異常値の処理（フラッシュクラッシュ等）
- [ ] 十分な期間（最低1年、理想は複数年）

### 3.2 検証の3段階

```
[1] バックテスト（過去データ）
    ↓ パラメータ決定
[2] フォワードテスト（直近の未使用データ）
    ↓ 性能確認
[3] ペーパートレード（リアルタイム・実資金なし）
    ↓ 実運用判断
```

**Prism への適用**: 現状は [1] のみ。[2] フォワードテスト機能（データの後半N%を自動的にOOS用に確保）の追加が有効。

### 3.3 評価指標の使い分け

| 目的 | 指標 | 解釈 |
|------|------|------|
| リスク調整後リターン | **Sharpe Ratio** | 1.0超で実用圏 |
| 最大損失リスク | **Max Drawdown** | 20%超は危険 |
| 勝率だけでは不十分 | **Profit Factor** | 1.5超で実用圏 |
| 勝ちの質 | **Win Rate × Avg Win / Avg Loss** | 期待値がプラスか |

---

## 4. バックテスト過学習の統計的検出（CPCV法）

出典: [Gort et al. (2022) - arXiv:2209.05559](https://arxiv.org/abs/2209.05559)
"Detecting Backtest Overfitting in Financial DRL using CPCV"

### 4.1 核心の問題

> 深層強化学習（DRL）エージェントはハイパーパラメータに極めて敏感で、同一アルゴリズムでもパラメータを変えるだけで「爆益」にも「爆損」にもなる。

研究者が何百通りものパラメータを試し、その中で「一番良かった結果」だけを報告する
→ これは **Multiple Testing（多重検定）問題** そのもの。
2700通り試して50個選べば、偶然当たりを引く確率は極めて高い。

論文はこの問題を **CPCV（Combinatorial Purged Cross-Validation）** で定量的に検出する手法を提案。

### 4.2 CPCV の仕組み

#### データ分割

時系列データを **N=5 グループ** に分割し、その中から **k=2 グループ** をテスト用に選ぶ。
残りの N-k=3 グループが訓練用。

組み合わせ数: **J = C(N, N-k) = C(5, 3) = 10 通り**

```
グループ:    [G1]  [G2]  [G3]  [G4]  [G5]

分割 1:    [Test] [Test] [Train][Train][Train]
分割 2:    [Test] [Train][Test] [Train][Train]
分割 3:    [Test] [Train][Train][Test] [Train]
分割 4:    [Test] [Train][Train][Train][Test]
分割 5:    [Train][Test] [Test] [Train][Train]
分割 6:    [Train][Test] [Train][Test] [Train]
分割 7:    [Train][Test] [Train][Train][Test]
分割 8:    [Train][Train][Test] [Test] [Train]
分割 9:    [Train][Train][Test] [Train][Test]
分割10:    [Train][Train][Train][Test] [Test]
```

**パージ（Purging）**: 訓練とテストの境界で情報漏洩が起きないよう、隣接するバーを除外。
金融時系列は自己相関が強いので、単純にデータを切るだけでは「未来の情報が訓練に漏れる」。

#### 過学習確率の推定

各組み合わせ `c` について:
1. 訓練データで H=50 回のハイパーパラメータ試行を実行
2. 各試行のテストデータでのリターン `r̄^c[ε]` を計算
3. 相対ランク: **ω^c = r̄^c[ε*] / (H+1)**
   - ε* = 訓練データで最も良かったパラメータ
   - そのパラメータが「テストデータでも何位か」を測る
4. ロジット変換: **λ^c = ln(ω^c / (1 - ω^c))**
5. 10通りの λ^c の分布から確率を計算:

   **p = ∫_{-∞}^{0} f(λ) dλ**

   - p = 「テストで中央値以下（= 過学習している）」の確率
   - f(λ) は 10個の λ^c から推定したカーネル密度

#### 仮説検定

- **H0（帰無仮説）**: p < α → 過学習していない
- **H1（対立仮説）**: p ≥ α → 過学習している
- **α = 10%**（論文の設定）

→ p ≥ 10% なら「このエージェントは過学習している」と判定し、**棄却**する。

### 4.3 実験設計

#### 対象銘柄（10銘柄）

AAVE, AVAX, BTC, NEAR, LINK, ETH, LTC, MATIC, UNI, SOL

#### データ

- **時間足**: 5分足
- **訓練期間**: 2022/02/02 〜 2022/04/30（約3ヶ月）
- **テスト期間**: 2022/05/01 〜 2022/06/27（約2ヶ月）
  - テスト期間は **TerraUSD崩壊（5月）** と **3AC/Celsius破綻（6月）** の2つのクラッシュを含む
  - → 極めて厳しい市場環境での検証

#### 特徴量エンジニアリング

初期15個の技術指標から、**相関係数 ±0.6 超** のペアを除去:

| # | 特徴量 | 説明 |
|---|--------|------|
| 1 | **Volume** | 取引量 |
| 2 | **RSI** | 相対力指数 |
| 3 | **DX** | 方向性指数 |
| 4 | **ULTSOC** | アルティメットオシレーター |
| 5 | **OBV** | オンバランスボリューム |
| 6 | **HT** | ヒルベルト変換（トレンドライン） |

→ 相関の強い特徴量を残すと、モデルが冗長な情報で過学習しやすくなるため削減。

#### ハイパーパラメータ探索

- 6つのハイパーパラメータを変動（学習率、バッチサイズ、ネットワーク構造など）
- 全組み合わせ: **2,700通り**
- そこからランダムに **H=50 試行** を抽出して CPCV で評価

#### リスク制御: CVIX

- **CVIX（Crypto Volatility Index）**: 暗号資産市場のボラティリティ指標
- **閾値: 90.1** を超えたらポジションを閉じる / エントリーしない
- 暴落時に無駄にポジションを持たないための安全装置

### 4.4 実験結果（Table 3）

| エージェント | テストリターン | ボラティリティ | 過学習確率 p | 判定 |
|-------------|--------------|--------------|-------------|------|
| **PPO (CPCV)** | **-34.96%** | 2.01×10⁻³ | **8.0%** | ✅ 採用（p < 10%） |
| PPO (Walk-Forward) | -49.39% | - | 17.5% | ❌ 棄却（p ≥ 10%） |
| SAC | -59.48% | - | **21.3%** | ❌ 棄却（最も過学習） |
| A2C | -45.12% | - | 13.2% | ❌ 棄却 |
| S&P Buy & Hold | -50.78% | - | - | ベンチマーク |

**解釈**:

1. **全エージェントがマイナスリターン** — テスト期間がTerra/3ACクラッシュなので当然
2. **「負け方が小さい」のが勝ち** — PPO(CPCV) の -34.96% は市場(-50.78%)より16%良い
3. **SAC は p=21.3% で棄却** — 訓練では良く見えたが、テストでの相対順位が低い = 過学習
4. **Walk-Forward 方式でも p=17.5% で棄却** — CPCV の方が Walk-Forward より過学習検出力が高い
5. **CPCV で選ばれたエージェントだけが α=10% を通過** — 過学習フィルタとして有効

### 4.5 なぜ重要か

この論文が示す最大の教訓:

> **「テストで勝った」は意味がない。「テストでの順位が、訓練での順位と一致する」かが重要。**

- 2,700通りのパラメータから「テストで一番良い」を選ぶ = データスヌーピング
- CPCV は「訓練で一番良いパラメータが、テストでも上位か？」を 10通りの分割で検証
- その確率が低い (p ≥ 10%) なら → 訓練の好成績は偶然 → 棄却

### 4.6 Prism への適用

現状のグリッドサーチは「全組み合わせの中からベストを選ぶ」方式。
これ自体がデータスヌーピングになるリスクがある。

**短期的な対策（すぐ実装可能）**:
1. データを **Train (60%) / Validation (20%) / Test (20%)** に3分割
2. グリッドサーチは Train + Validation で実施
3. 最終評価は Test データでのみ行う（1回限り）
4. Test での Sharpe が 1.0 未満なら「エッジなし」と判断して棄却

**中期的な対策（CPCV 簡易版）**:
1. データを **N=5 グループ** に分割
2. C(5,3)=10 通りの Train/Test 組み合わせで検証
3. 各組み合わせで「Train ベストのパラメータ」の Test 順位を記録
4. 過学習確率 p を計算し、**p ≥ 10% なら棄却**

**特徴量の教訓**:
- 相関の高い指標を全部入れない（±0.6 超は除去）
- 6個程度の独立した指標に絞ることで過学習を抑制
- Prism のテンプレートで使う指標も同様に精査すべき

**リスク制御の教訓**:
- ボラティリティが極端に高い時期はポジションを持たない
- CVIX 閾値のような「自動停止メカニズム」を検討

---

## 5. BTC予測ML手法の包括的比較

出典: [arXiv:2407.18334](https://arxiv.org/html/2407.18334v1)

### 5.1 実験設計

- **41モデル**（分類器21 + 回帰器20）を比較
- **訓練**: 2013-2023（10年）、**バックテスト**: 2023年2-7月、**フォワード**: 2023年8-10月
- ローリングウィンドウ: 1, 7, 14, 21, 28日

### 5.2 最重要の知見

| モデル | バックテスト利益率 | フォワード利益率 | Sharpe（BT→FW） |
|--------|------------------|-----------------|-----------------|
| BernoulliNB | 113.31% | 29.78% | - |
| RandomForest (分類) | 87.75% | 15.38% | 6.3 → 8.68 |
| SGD (回帰) | 81.28% | 34.01% | 5.34 |
| RadiusNeighbors | 26.97% | 12.78% | - |

**核心**: バックテストの利益率が高いモデルほど、フォワードでの落差が大きい。
**例外**: RadiusNeighbors（小ウィンドウ1日）はバックテスト控えめだがフォワードでの劣化も小さい。

### 5.3 教訓

1. **バックテスト結果だけで判断するな** — フォワードテストが必須
2. **複雑なモデル ≠ 良い結果** — シンプルなモデルが安定することがある
3. **Sharpe Ratio の安定性を見よ** — 利益率よりSharpeの BT→FW 一貫性が重要
4. **バックテストで良すぎる結果は疑え** — 113%→30% のような大幅劣化は過学習の典型

### 5.4 Prism への適用

現在のテンプレート（MA Crossover, RSI Reversal 等）は「ルールベース」であり、
MLモデルよりは過学習リスクが低い。ただしグリッドサーチでパラメータを大量に試す点は同じリスク。

---

## 6. Walk-Forward Validation Framework

出典: [arXiv:2512.12924](https://arxiv.org/html/2512.12924v1)

### 6.1 衝撃的な事実

> 学術論文で報告された取引戦略の **90%以上** が、実資金で実行すると失敗する。

原因:
- インサンプルのパラメータ最適化による過学習
- 先読みバイアス（リアルタイムで利用不可能な情報の使用）
- ブラックボックスモデルによる解釈不能性
- 非現実的な実行仮定

### 6.2 4つのイノベーション

1. **情報セット規律**: 各時点で利用可能なデータのみを厳密に使用
2. **Walk-Forward検証**: 34の独立したOOS期間でテスト（1回の幸運なバックテストではなく）
3. **完全な解釈可能性**: 全トレードが人間が読める仮説から生成される
4. **現実的な実行仮定**: 手数料、スリッページ、ポジション制限、損切りルールを反映

### 6.3 正直な結果

5つのマーケットマイクロストラクチャーパターンを100の米国株（2015-2024）で検証:
- 年間リターン: **0.55%**（Sharpe 0.33）
- 最大DD: **-2.76%**（SPYは-23.8%）
- p値: **0.34**（統計的に有意ではない）

**この「正直な結果」が重要**。厳密な検証をすると、多くの戦略は統計的に有意なエッジを持たない。

### 6.4 レジーム依存性

- 高ボラティリティ期（2020-2024）: +0.60%/四半期
- 低ボラティリティ期（2015-2019）: -0.16%/四半期

→ エッジは市場環境に強く依存する。「いつでも勝てる戦略」は存在しない。

### 6.5 Prism への適用

最も重要な教訓は **Walk-Forward の実装**:
```
期間1: [Train: 2023-01~06][Test: 2023-07~09]
期間2: [Train: 2023-04~09][Test: 2023-10~12]
期間3: [Train: 2023-07~12][Test: 2024-01~03]
...
（ローリングで複数のOOS期間を作る）
```

1回のバックテストで「勝てた」は意味がない。複数の独立したOOS期間で一貫して勝てるかが本質。

---

## 7. Prism 開発ロードマップへの提言

### 7.1 今すぐやるべきこと（Critical）

| # | 項目 | 理由 |
|---|------|------|
| 1 | **データ3分割** (Train/Val/Test) | グリッドサーチの結果をそのまま信じるのはデータスヌーピング |
| 2 | **OOS自動検証** | テストデータでの評価を1回限りで実施する仕組み |
| 3 | **過学習警告フラグ** | PF>2.0, Sharpe>3.0 で ⚠️ 表示 |

### 7.2 次にやるべきこと（Important）

| # | 項目 | 理由 |
|---|------|------|
| 4 | **Walk-Forward Analysis** | 複数のOOS期間で一貫性を検証 |
| 5 | **BT→FW 劣化率の表示** | バックテスト vs フォワードの乖離を可視化 |
| 6 | **最低トレード数フィルタ** | N<30 の結果は統計的に無意味として非表示 |

### 7.3 将来的にやると強い（Nice to have）

| # | 項目 | 理由 |
|---|------|------|
| 7 | **モンテカルロシミュレーション** | ランダム性の影響を推定 |
| 8 | **CPCV実装** | 過学習確率の定量的推定 |
| 9 | **複数銘柄OOS横断分析** | 1銘柄で勝てても他で負ければ過学習 |

---

## 8. 判断基準チートシート

### 「このエッジは本物か？」チェックリスト

- [ ] OOS（未知データ）で検証したか？
- [ ] トレード数は30以上あるか？（理想は100+）
- [ ] Sharpe Ratio は OOS で 1.0 以上あるか？
- [ ] 複数の市場レジーム（上昇/下降/レンジ）で機能するか？
- [ ] 複数銘柄で一貫性があるか？
- [ ] 実行コスト（手数料 + スリッページ）込みでプラスか？
- [ ] Profit Factor が 1.5-2.0 の「現実的な」範囲か？（3.0超は疑え）
- [ ] パラメータを少し変えても結果が大きく変わらないか？（ロバスト性）

**上記の全てに ✅ が付かない限り、実資金を投入してはならない。**

---

## 参考文献

1. [FX Replay - Backtesting Biases](https://www.fxreplay.com/learn/backtesting-biases-how-traders-fool-themselves-without-knowing-it)
2. [LuxAlgo - Backtesting Traps](https://www.luxalgo.com/blog/backtesting-traps-common-errors-to-avoid/)
3. [3Commas - AI Crypto Trading Backtesting Guide](https://3commas.io/blog/comprehensive-2025-guide-to-backtesting-ai-trading)
4. [Gort et al. (2022) - DRL Backtest Overfitting](https://arxiv.org/pdf/2209.05559)
5. [ML Models for Bitcoin Trading (2024)](https://arxiv.org/html/2407.18334v1)
6. [Walk-Forward Validation Framework (2025)](https://arxiv.org/html/2512.12924v1)
