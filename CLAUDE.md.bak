# Project: Prism (backtest-system)

## Goal

仮想通貨トレード戦略のバックテスト・分析・自動最適化を行うWebダッシュボードシステム。

- OHLCVデータの読み込み（Binance CSV/ZIP, TradingView CSV）
- GUI上で戦略を組み立てて1回バックテスト実行・分析
- 21種テンプレート × パラメータグリッドサーチ/GA × トレンドレジーム別の自動最適化
- Modal クラウド並列実行（データ取得→最適化→結果DL）
- 最適化結果のJSON保存・読み込み・YAML戦略エクスポート

## Current state

### 完成済み機能
- **データローダー**: Binance CSV/ZIP一括読み込み、TradingView CSV対応、TF自動判定
- **戦略ビルダー**: インジケーター・エントリー条件・決済ルールをGUIで設定（YAML入出力対応）
- **バックテストエンジン**: bar-by-bar シミュレーション（TP/SL/トレーリングストップ/タイムアウト）
- **トレード分析**: 個別トレード詳細チャート・損益分布・勝敗統計・決済タイプ分布
- **自動最適化**: 21種テンプレート × グリッドサーチ/GA × レジーム別。複合スコアでランキング
- **Exit Profiles**: ATR固定/トレーリング/VWAP/BB系 全69パターン + コンパクト3択モード
- **Modal並列実行**: `scripts/modal_optimize.py` でクラウド上バッチ最適化
- **Dual-TF EMAレジーム検出**: 4h+1h EMA合意方式（`analysis/trend.py`）
- **OOS検証**: train 60% / val 20% / test 20% のアウトオブサンプル検証
- **最適化結果JSON読み込み**: `results/` フォルダのJSON → 結果ビュー表示（`OptimizationResultSet.from_json()`）
- **レジーム別ベスト戦略サマリー**: 各レジームの最適戦略カード表示 + YAML一括エクスポート
- **UI**: Streamlit WebUI、ダークテーマ、カスタムCSS、ワークフローガイド

### テンプレート一覧（21種）
| テンプレート | 概要 | Long/Short |
|-------------|------|-----------|
| MA Crossover | SMA fast/slow クロス | Long+Short |
| RSI Reversal | RSI売られすぎ/買われすぎ反発 | Long+Short |
| BB Bounce | ボリンジャーバンド下限/上限タッチ | Long+Short |
| MACD Signal | MACDラインクロス | Long+Short |
| Volume Spike | 出来高急増 + 陰線/陽線反転 | Long+Short |
| Stochastic Reversal | ストキャスティクス K/D クロス | Long+Short |
| VP Pullback | Volume Profile POCへの押し目 | Long |
| VWAP Touch/Sigma | VWAP系エントリー | Long+Short |

### UI名称
- システム名: **Prism**（旧: Backtest System）
- ページタイトル: `Prism`
- サイドバー: `🔷 Prism` + `戦略バックテスト＆最適化ツール`

## Architecture

```
backtest-system/
├── analysis/          # トレンドレジーム検出（MA Cross, ADX, Combined, Dual-TF EMA）
├── config/            # 設定（settings.py: STREAMLIT_PAGE_TITLE等）
├── data/              # データ読み込み（csv_loader, binance_loader, base）
├── engine/            # バックテストエンジン（backtest.py）
├── indicators/        # インジケーター（SMA, EMA, RSI, BB, MACD, ADX, Stoch, VWAP等）
├── metrics/           # パフォーマンス指標計算（calculator.py: BacktestMetrics）
├── optimizer/         # グリッドサーチ・テンプレート・スコアリング・結果（results.py）
├── results/           # 最適化結果JSON保存先
├── scripts/           # Modal実行スクリプト（fetch_data, upload, optimize, download）
├── strategy/          # 戦略定義・ビルダー・YAML例（examples/）
├── ui/
│   ├── app.py         # メインアプリ（Prism）
│   ├── components/    # 共通コンポーネント（chart, styles, metrics_card, trade_table）
│   └── views/         # 各ページ
│       ├── data_loader.py        # データ読み込みページ
│       ├── strategy_builder.py   # 戦略ビルダーページ
│       ├── backtest_runner.py    # バックテスト実行ページ
│       ├── trade_analysis.py     # トレード分析ページ
│       └── optimizer_page.py     # 最適化ページ（設定/結果/読込の3ビュー）
├── inputdata/         # 入力データ置き場
├── sample_data/       # サンプルデータ
└── tests/             # テスト
```

### Key data structures
- `OptimizationEntry`: 1パラメータ組み合わせの結果（template_name, params, trend_regime, metrics, composite_score）
- `OptimizationResultSet`: 最適化結果セット（entries, symbol, execution_tf, htf）。`from_json()` でJSON復元可能
- `BacktestMetrics`: バックテスト指標（trades, win_rate, profit_factor, max_dd, sharpe等）
- `BacktestResult`: バックテスト結果（trades, df, portfolio）

## Tech stack

- Python 3.10+
- Streamlit（WebUI）
- Plotly（チャート）
- pandas / numpy（データ処理）
- ccxt（取引所API）
- PyYAML（戦略設定）
- Modal（クラウド並列実行）

## Coding style

- Python 3.10+
- 関数は小さくテストしやすい単位で
- ログ出力と例外処理を明確に
- ファイル名・関数名・クラス名・変数名は英語
- UI表示テキスト・コメント・説明は日本語

### パフォーマンス最優先ルール（必須）

数値データ・OHLCV処理では**常に最速の実装**を選ぶこと。1分足データ（数十万行）を扱うため、遅いコードは致命的。

**禁止パターン:**
- `for row in df.iterrows()` / `for row in df.itertuples()` でのループ処理
- Python for文による行単位のDataFrame操作
- リスト内包表記で1行ずつ計算してからDataFrameに変換

**必須パターン:**
- pandas のベクトル演算（`df["col"] = df["a"] + df["b"]`）
- numpy の配列演算（`np.where()`, `np.maximum()`, `np.cumsum()` 等）
- pandas の `.shift()`, `.rolling()`, `.expanding()`, `.cummax()`, `.clip()` 等
- boolean indexing（`df[df["rsi"] < 30]`）

**判断基準:** 「Pythonのforループで書けるが、numpy/pandasのベクトル演算でも書ける」場合は、**例外なくベクトル演算を使う**。

## Workflow rules for Claude Code

- 複雑な変更は必ず最初にPLAN提示
- 変更は論理的な単位で小さく進める
- ファイル削除や構造変更は事前確認必須
- **ユーザーの明示的な指示なく勝手に作業を進めない**

### 戦略探索ワークフロー（自動ガイド）

セッション開始時にロードマップ（`.claude/memory/roadmap.md`）を読んだ場合、以下を自動で報告:
1. **現在のステップ**: 完了済み/進行中のステップ番号と概要
2. **最新ランの結果**: 直近のRun IDとOOS PASS率
3. **次のアクション候補**: ロードマップの「次のステップ」に基づく提案

ユーザーが「next-step」「次のステップ」「次」等と言ったら、`.claude/skills/next-step.md` の手順に従い、詳細な分析→提案→実行まで一連のフローを実行。（VSCodeではスラッシュコマンドが使えないため、キーワードで起動する）

**探索の鉄則（確定済み）:**
- BB系複合テンプレートのみが銘柄横断で機能する
- Stoch+BB, MACD+BB, RSI+MACD は全滅（検証済み、再テスト不要）
- RSI+BB と BB+Volume が唯一の有効パターン
- 新しい複合を試す場合は必ずBBを含める

### セッションメモリ（重要）

- **セッション開始時**: `.claude/memory/sessions/` の直近3ファイルを読み、前回までの文脈を把握すること
- **セッション終了時**: ユーザーが「メモリ保存して」と言ったら会話要約を保存する
- **保存リマインド（必須）**:
  - **コミット実行後**: 必ず「メモリ保存しますか？」と確認する
  - **大きな機能実装完了後**: 必ず確認する
  - **5回以上のやり取りが続いたら**: 定期的に確認する
  - **ユーザーが「また後で」「一旦ここまで」等と言ったら**: 即座に確認する
- **自発的保存**: ユーザーの明示的指示がなくても、セッション終了の兆候（長い沈黙、話題の区切り）があれば「メモリ保存しておきましょうか？」と提案する
- メモリファイルは通常のコミットに含めてpushする
- **失敗事例**: 2026-02-04にセッションリミット到達前の保存を怠り、作業内容が失われた。二度と繰り返さない

## Language rules

- 説明・計画・コメントは全て日本語
- ファイル名・ディレクトリ名・関数名・クラス名・コード識別子は英語
- 明示的に求められない限り英語に切り替えない

## 最適化の運用方針（2026-02-06時点）

### 確定した設定
- **レジーム検出**: Dual-TF EMA（4h+1h合意方式）。`--super-htf 4h`
- **Exit profiles**: `atr_compact`（SL=ATR×2.0固定、TP 3択）が標準
- **OOS**: 必須（train 60% / val 20% / test 20%）
- **データ期間**: 2年分が推奨

### 過学習防止の原則
- 探索空間は小さく保つ（exit compact, パラメータ数制限）
- OOSは検出のみ。防止には空間削減が必要
- 最低トレード数フィルタ（20件以上）を推奨
- 銘柄横断（symbol_count >= 2）で汎用性を確認

### 一貫した傾向
- **range > downtrend > uptrend**（OOS通過率の順）
- Uptrendは過学習しやすく、ほぼ全滅
- Downtrendは2銘柄(SOL, XRP)でPASS → 横断検証の価値あり

### 完全クラウドワークフロー
```
modal run scripts/modal_fetch_data.py     # データ取得（Binance → Volume）
modal run scripts/modal_optimize.py --exit-profiles atr_compact  # 最適化
modal run scripts/modal_download.py       # 結果DL
```

## Discussion notes

### 下落トレンド銘柄横断仮説（部分検証済み）
- ユーザーの仮説: 下落トレンドでは銘柄を問わず特定の戦略が機能するのではないか
- 検証結果: SOL(ma_crossover +4.9%)とXRP(rsi_reversal +25.5%)でdowntrend PASS確認
- ただしテンプレート自体は銘柄間で異なる → 「戦略は同じ」ではなく「レジームとしてエッジがある」
- **次のステップ**: 10銘柄に拡大して横断検証
